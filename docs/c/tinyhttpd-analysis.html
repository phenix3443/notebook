<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-04-26 日 10:53 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TinyHTTPd 源码分析</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="liushangliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript" src="./script/org-info.js">

<script type="text/javascript" src="https://orgmode.org/org-info.js">
/**
 *
 * @source: https://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in https://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2019 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in https://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "https://phenix3443.github.io/");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://phenix3443.github.io/"> HOME </a>
</div><div id="content">
<h1 class="title">TinyHTTPd 源码分析</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org46cf1da">1. 简介</a></li>
<li><a href="#orgff9ef67">2. 编译</a></li>
<li><a href="#org7d64971">3. 使用</a></li>
<li><a href="#orged381f6">4. 源码分析</a>
<ul>
<li><a href="#org95f4dca">4.1. 流程图</a></li>
<li><a href="#org1f4b624">4.2. 函数分析</a>
<ul>
<li><a href="#org9f1fd69">4.2.1. main</a></li>
<li><a href="#orgcf9d7c1">4.2.2. startup</a></li>
<li><a href="#org22d3570">4.2.3. <code>accept_request</code></a></li>
<li><a href="#org7d03941">4.2.4. <code>get_line</code></a></li>
<li><a href="#org07a1c8d">4.2.5. <code>execute_cgi</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7a17757">5. 附录</a>
<ul>
<li><a href="#org2593fc9">5.1. HTTP 报文格式</a>
<ul>
<li><a href="#org3b44d58">5.1.1. 请求报文</a></li>
<li><a href="#orgbc8c982">5.1.2. 响应报文</a></li>
</ul>
</li>
<li><a href="#org0a075c3">5.2. 换行、回车</a>
<ul>
<li><a href="#org7f684d3">5.2.1. 历史</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org46cf1da" class="outline-2">
<h2 id="org46cf1da"><span class="section-number-2">1</span> 简介</h2>
<div class="outline-text-2" id="text-1">
<p>
TinyHTTPd<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>是一个超轻量型 Http Server，使用 C 语言开发，可以通过阅读这段代码理解一个 Http Server 的本质。
</p>
</div>
</div>

<div id="outline-container-orgff9ef67" class="outline-2">
<h2 id="orgff9ef67"><span class="section-number-2">2</span> 编译</h2>
<div class="outline-text-2" id="text-2">
<p>
源程序是在 sparc solaris 2.6 下编译的，在 linux 下编译需要进行以下修改：
</p>
<ul class="org-ul">
<li><p>
<code>pthread_create</code> 函数第三个参数即回调函数名，要求是 <code>(void*)(*start_rtn)(void*)</code> 类型，但是代码中提供的 <code>accept_request</code> 函数是 <code>void (*)(int)</code> 类型的，因此无法通过编译。
</p>

<p>
第 33 行函数声明
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">void accept_request(int); </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #00d7af;">void</span> *<span style="color: #ffd700;">accept_request</span>(<span style="color: #00d7af;">void</span> *);
</pre>
</div>

<p>
第 52 行相应的函数定义
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">void accept_request(int client) </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
<span style="color: #00d7af;">void</span> *<span style="color: #ffd700;">accept_request</span>(<span style="color: #00d7af;">void</span> * <span style="color: #ff8700;">tclient</span>)
</pre>
</div>

<p>
第 131 行添加返回值
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #a1db00;">return</span> <span style="color: #5fafd7;">NULL</span>;
</pre>
</div>

<p>
第 503 行
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">if (pthread_create(&amp;newthread , NULL, accept_request, client_sock) != 0) </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #a1db00;">if</span> (pthread_create(&amp;newthread , <span style="color: #5fafd7;">NULL</span>, accept_request, (<span style="color: #00d7af;">void</span> *)&amp;client_sock) != 0)
</pre>
</div></li>
<li><p>
传入参数类型错误造成的，分别在 441 和 488 行，要求参数为 unsigned int 指针，传入为 int 类型，所以将相关参数类型改成 <code>socklen_t</code> 即可。
</p>

<p>
第 441 行
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">int namelen = sizeof(name); </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #00d7af;">socklen_t</span> <span style="color: #ff8700;">namelen</span> = <span style="color: #a1db00;">sizeof</span>(name);
</pre>
</div>
<p>
第 488 行
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">int client_name_len = sizeof(client_name); </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #00d7af;">socklen_t</span> <span style="color: #ff8700;">client_name_len</span> = <span style="color: #a1db00;">sizeof</span>(client_name);
</pre>
</div></li>

<li><p>
第 277 行 逻辑错误
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">execl(path, path, NULL); </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #ffd700;">execl</span>(path, query_string, <span style="color: #5fafd7;">NULL</span>);
</pre>
</div></li>

<li><p>
Makefile 添加 debug 选项、去掉 libsocket 的依赖。
</p>
<div class="org-src-container">
<pre class="src src-bash">        <span style="color: #6c6c6c; font-style: italic;"># </span><span style="color: #6c6c6c; font-style: italic;">gcc -W -Wall -lsocket -lpthread -o httpd httpd.c</span>
        gcc -g -W -Wall  httpd.c -o httpd -lpthread
</pre>
</div></li>
</ul>

<p>
执行 make 即可。
</p>
</div>
</div>
<div id="outline-container-org7d64971" class="outline-2">
<h2 id="org7d64971"><span class="section-number-2">3</span> 使用<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup></h2>
<div class="outline-text-2" id="text-3">
<p>
浏览器访问 <code>localhost:12345</code> 可以看到 index.html 页面。
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/index.png" alt="index.png" />
</p>
<p><span class="figure-number">Figure 1: </span>index.html</p>
</div>

<p>
页面提示说要在输入框里面输入一个 color，但是填了 red 什么都没有什么正常的反馈，看一下源码：
</p>
<div class="org-src-container">
<pre class="src src-xml">      &lt;<span style="color: #ffd700;">FORM</span> <span style="color: #ff8700;">ACTION</span>=<span style="color: #ff4ea3;">"color.cgi"</span> <span style="color: #ff8700;">METHOD</span>=<span style="color: #ff4ea3;">"POST"</span>&gt;
      Enter a color: &lt;<span style="color: #ffd700;">INPUT</span> <span style="color: #ff8700;">TYPE</span>=<span style="color: #ff4ea3;">"text"</span> <span style="color: #ff8700;">NAME</span>=<span style="color: #ff4ea3;">"color"</span>&gt;
      &lt;<span style="color: #ffd700;">INPUT</span> <span style="color: #ff8700;">TYPE</span>=<span style="color: #ff4ea3;">"submit"</span>&gt;
</pre>
</div>
<p>
简单说一下 Form 本身的参数：ACTION 是指向 CGI 脚本的 URL。METHOD 可以是 GET 或 POST。 区别在于使用 GET 的情况下，值会显示在浏览器的地址栏里，而使用 POST 时，他们会被隐藏。
</p>

<p>
简单来看一下 color.cgi：
</p>

<p>
加载 CGI 模块，并创建一个新的 CGI 对象，my 作用类似 lua 里面的 local，用来定义变量。
</p>
<div class="org-src-container">
<pre class="src src-perl">      <span style="color: #a1db00;">use</span> <span style="color: #5fafd7;">CGI</span>;
      <span style="color: #00d7af;">my</span>($<span style="color: #ff8700;">cgi</span>) = new CGI;
</pre>
</div>
<p>
这里有两个目的：一个是打印出 HTTP 响应报头，一个是从提交的表单中获取参数。
</p>
<div class="org-src-container">
<pre class="src src-perl">      print $<span style="color: #ff8700;">cgi</span>-&gt;header;             <span style="color: #6c6c6c; font-style: italic;"># &#25171;&#21360; HTTP &#21709;&#24212;&#25253;&#22836;&#65292;&#31867;&#20284; print "Content-Type: text/html; charset=ISO-8859-1\r\n";</span>
      <span style="color: #00d7af;">my</span>($<span style="color: #ff8700;">color</span>) = <span style="color: #ff4ea3;">"blue"</span>;            <span style="color: #6c6c6c; font-style: italic;"># &#23450;&#20041; color &#21464;&#37327;</span>
      $<span style="color: #ff8700;">color</span> = $<span style="color: #ff8700;">cgi</span>-&gt;param(<span style="color: #ff4ea3;">'color'</span>) <span style="color: #a1db00;">if</span> defined $<span style="color: #ff8700;">cgi</span>-&gt;param(<span style="color: #ff4ea3;">'color'</span>); <span style="color: #6c6c6c; font-style: italic;"># &#20174;&#25552;&#20132;&#30340;&#34920;&#21333;&#20013;&#33719;&#21462;&#21442;&#25968;</span>
</pre>
</div>
<p>
cgi 输出：
</p>
<div class="org-src-container">
<pre class="src src-perl">      print $<span style="color: #ff8700;">cgi</span>-&gt;start_html(-title =&gt; uc($<span style="color: #ff8700;">color</span>),-BGCOLOR =&gt; $<span style="color: #ff8700;">color</span>); <span style="color: #6c6c6c; font-style: italic;"># start the html</span>
      print $<span style="color: #ff8700;">cgi</span>-&gt;h1(<span style="color: #ff4ea3;">"This is $color"</span>); <span style="color: #6c6c6c; font-style: italic;"># level1 header</span>
      print $<span style="color: #ff8700;">cgi</span>-&gt;end_html;             <span style="color: #6c6c6c; font-style: italic;"># end the html</span>
</pre>
</div>
<p>
看到这里应该想到返回的 html 的内容了：一个设置了标题、背景色、header 的 html 页面。我们试试：在输入框填入#0000FF（蓝色），提交。
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/display-abnormal.png" alt="display-abnormal.png" />
</p>
<p><span class="figure-number">Figure 2: </span>没有返回</p>
</div>

<p>
可是还是没有返回结果，问题出在哪里呢？先单独执行一下 color.cgi 看看是不是它的问题。
</p>
<pre class="example">
      $ ./color.cgi
      bash: ./color.cgi: /usr/local/bin/perl: 解释器错误: 没有那个文件或目录
</pre>
<p>
原来是 perl 的路径没找到。找一下本机的 perl 路径：
</p>
<div class="org-src-container">
<pre class="src src-bash">      which perl
</pre>
</div>
<p>
重新设定 color.cgi 中的 perl 路径，
</p>
<div class="org-src-container">
<pre class="src src-perl">      <span style="color: #6c6c6c; font-style: italic;">#!/usr/bin/perl -Tw</span>
</pre>
</div>
<p>
再试：
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/display-normal.png" alt="display-normal.png" />
</p>
<p><span class="figure-number">Figure 3: </span>正常显示</p>
</div>
</div>
</div>

<div id="outline-container-orged381f6" class="outline-2">
<h2 id="orged381f6"><span class="section-number-2">4</span> 源码分析<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup></h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org95f4dca" class="outline-3">
<h3 id="org95f4dca"><span class="section-number-3">4.1</span> 流程图<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup></h3>
<div class="outline-text-3" id="text-4-1">

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/tinyhttpd-work-flow.png" alt="tinyhttpd-work-flow.png" />
</p>
<p><span class="figure-number">Figure 4: </span>程序流程图</p>
</div>
</div>
</div>
<div id="outline-container-org1f4b624" class="outline-3">
<h3 id="org1f4b624"><span class="section-number-3">4.2</span> 函数分析</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org9f1fd69" class="outline-4">
<h4 id="org9f1fd69"><span class="section-number-4">4.2.1</span> main</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
main 函数通过 startup 函数来绑定和监听端口,accept 一个客户端链接后创建一个线程调用 <code>accept_request</code> 函数来处理用户发来的 HTTP 请求报文。
</p>
</div>
</div>
<div id="outline-container-orgcf9d7c1" class="outline-4">
<h4 id="orgcf9d7c1"><span class="section-number-4">4.2.2</span> startup</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
startup 函数很简单，不做过多的分析。
</p>
</div>
</div>
<div id="outline-container-org22d3570" class="outline-4">
<h4 id="org22d3570"><span class="section-number-4">4.2.3</span> <code>accept_request</code></h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
<code>accept_request</code> 通过 <code>get_line</code> 按行处理 HTTP 请求。
</p>
<ul class="org-ul">
<li>请求行
<ul class="org-ul">
<li>将请求方法放在 method 中，只能处理 get 或者 post 方法，如果是 post 方法设置 cgi 处理标识。</li>
<li>判断是何种 method（GET or POST）以及获取 url。对于 GET 方法，如果携带参数，设置 cgi 处理标识，截断 url，并将 <code>query_string</code> 指针指向 url 中 ? 后面的 GET 参数。</li>
<li>将 htdocs 与 url 拼接为 path，如果 path 最后一个字符是‘/’，则继续拼接 index.html，即默认访问 path 下的 index.html 文件。</li>
<li>如果 path 所指的文件不存在，读取并丢弃剩余请求首部，并向客户端返回 404 错误。</li>
<li>如果 path 所指文件存在，是目录则拼接 index.html，是文件则根据是否可执行设置 cgi 标识。</li>
<li>根据 cgi 标识决定执行 <code>serve_file</code> 还是 <code>execute_cgi</code> 。</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #00d7af;">void</span> <span style="color: #ffd700;">accept_request</span>(<span style="color: #00d7af;">int</span> <span style="color: #ff8700;">client</span>)
        {
            <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">buf</span>[1024];
            <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">numchars</span>;
            <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">method</span>[255];           <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20445;&#23384;&#35831;&#27714;&#34892;&#20013;&#30340;&#35831;&#27714;&#26041;&#27861; GET or POST</span>
            <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">url</span>[255];   <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#35831;&#27714;&#34892;&#30340; url &#23383;&#27573;</span>
            <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">path</span>[512];  <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#35831;&#27714;&#34892;&#20013;&#25991;&#20214;&#22312;&#26381;&#21153;&#22120;&#19978;&#30340;&#36335;&#24452;</span>
            <span style="color: #00d7af;">size_t</span> <span style="color: #ff8700;">i</span>, <span style="color: #ff8700;">j</span>;
            <span style="color: #a1db00;">struct</span> <span style="color: #00d7af;">stat</span> <span style="color: #ff8700;">st</span>;
            <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">cgi</span> = 0;      <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">becomes true if server decides this is a CGI</span>
<span style="color: #6c6c6c; font-style: italic;">                               * program </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">query_string</span> = <span style="color: #5fafd7;">NULL</span>; <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">get &#35831;&#27714;&#65311;&#20043;&#21518;&#30340;&#26597;&#35810;&#21442;&#25968;</span>

            numchars = get_line(client, buf, <span style="color: #a1db00;">sizeof</span>(buf));<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#33719;&#21462;&#35831;&#27714;&#34892;</span>
            i = 0; j = 0;
            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#22788;&#29702;&#35831;&#27714;&#34892; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#35831;&#27714;&#26041;&#27861; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #a1db00;">while</span> (<span style="color: #ff4b4b;">!</span>ISspace(buf[j]) &amp;&amp; (i &lt; <span style="color: #a1db00;">sizeof</span>(method) - 1))
            {
                method[i] = buf[j];<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#26681;&#25454; http &#35831;&#27714;&#25253;&#25991;&#26684;&#24335;&#65292;&#36825;&#37324;&#24471;&#21040;&#30340;&#26159;&#35831;&#27714;&#26041;&#27861;</span>
                i++; j++;
            }
            method[i] = <span style="color: #ff4ea3;">'\0'</span>;
            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#30465;&#30053; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">URL &#23383;&#27573; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #a1db00;">while</span> (<span style="color: #ff4b4b;">!</span>ISspace(buf[j]) &amp;&amp; (i &lt; <span style="color: #a1db00;">sizeof</span>(url) - 1) &amp;&amp; (j &lt; <span style="color: #a1db00;">sizeof</span>(buf)))
            {
                url[i] = buf[j];<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#33719;&#21462;&#30340;&#26159; URL&#65288;&#20114;&#32852;&#32593;&#26631;&#20934;&#36164;&#28304;&#30340;&#22320;&#22336;&#65289;</span>
                i++; j++;
            }
            url[i] = <span style="color: #ff4ea3;">'\0'</span>;

            <span style="color: #a1db00;">if</span> (strcasecmp(method, <span style="color: #ff4ea3;">"GET"</span>) == 0)
            {
                query_string = url;<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#35831;&#27714;&#20449;&#24687;</span>
                <span style="color: #a1db00;">while</span> ((*query_string != <span style="color: #ff4ea3;">'?'</span>) &amp;&amp; (*query_string != <span style="color: #ff4ea3;">'\0'</span>))<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#25130;&#21462;'?'&#21069;&#30340;&#23383;&#31526;</span>
                    query_string++;<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#38382;&#21495;&#21069;&#38754;&#26159;&#36335;&#24452;&#65292;&#21518;&#38754;&#26159;&#21442;&#25968;</span>
                <span style="color: #a1db00;">if</span> (*query_string == <span style="color: #ff4ea3;">'?'</span>)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#26377;'?'&#65292;&#34920;&#26126;&#21160;&#24577;&#35831;&#27714;</span>
                {
                    cgi = 1;
                    *query_string = <span style="color: #ff4ea3;">'\0'</span>;
                    query_string++;
                }
            }
            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#26681;&#25454; url &#25340;&#25509; url &#22312;&#26381;&#21153;&#22120;&#19978;&#30340;&#36335;&#24452; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            sprintf(path, <span style="color: #ff4ea3;">"htdocs%s"</span>, url);
            <span style="color: #a1db00;">if</span> (path[strlen(path) - 1] == <span style="color: #ff4ea3;">'/'</span>)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#22914;&#26524; url &#26159;&#30446;&#24405;(/)&#65292;&#21017;&#21152;&#19978; index.html</span>
                strcat(path, <span style="color: #ff4ea3;">"index.html"</span>);<span style="color: #6c6c6c; font-style: italic;">//</span>

            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#26597;&#25214; path &#25351;&#21521;&#30340;&#25991;&#20214; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #a1db00;">if</span> (stat(path, &amp;st) == -1) {<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#25191;&#34892;&#22833;&#36133;&#65292;&#25991;&#20214;&#26410;&#25214;&#21040;</span>
                <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#20002;&#24323;&#25152;&#26377; headers &#30340;&#20449;&#24687;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
                <span style="color: #a1db00;">while</span> ((numchars &gt; 0) &amp;&amp; strcmp(<span style="color: #ff4ea3;">"\n"</span>, buf))  <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">read &amp; discard headers </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
                    numchars = get_line(client, buf, <span style="color: #a1db00;">sizeof</span>(buf));<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20174;&#23458;&#25143;&#31471;&#35835;&#21462;&#25968;&#25454;&#36827; buf</span>
                not_found(client);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#22238;&#24212;&#23458;&#25143;&#31471;&#25214;&#19981;&#21040;</span>
            }
            <span style="color: #a1db00;">else</span>
            {
                <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#22914;&#26524; path &#26159;&#20010;&#30446;&#24405;&#65292;&#21017;&#40664;&#35748;&#20351;&#29992;&#35813;&#30446;&#24405;&#19979; index.html &#25991;&#20214;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
                <span style="color: #a1db00;">if</span> ((st.st_mode &amp; S_IFMT) == S_IFDIR)
                    strcat(path, <span style="color: #ff4ea3;">"/index.html"</span>);
                <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">&#22914;&#26524; path &#26159;&#21487;&#25191;&#34892;&#25991;&#20214;&#65292;&#35774;&#32622; cgi &#26631;&#35782; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
                <span style="color: #a1db00;">if</span> ((st.st_mode &amp; S_IXUSR) ||
                    (st.st_mode &amp; S_IXGRP) ||
                    (st.st_mode &amp; S_IXOTH)    )
                    cgi = 1;
                <span style="color: #a1db00;">if</span> (<span style="color: #ff4b4b;">!</span>cgi)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#38745;&#24577;&#39029;&#38754;&#35831;&#27714;</span>
                    serve_file(client, path);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#30452;&#25509;&#36820;&#22238;&#25991;&#20214;&#20449;&#24687;&#32473;&#23458;&#25143;&#31471;&#65292;&#38745;&#24577;&#39029;&#38754;&#36820;&#22238;</span>
                <span style="color: #a1db00;">else</span><span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#21160;&#24577;&#39029;&#38754;&#35831;&#27714;</span>
                    execute_cgi(client, path, method, query_string);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#25191;&#34892; cgi &#33050;&#26412;</span>
            }

            close(client);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20851;&#38381;&#23458;&#25143;&#31471;&#22871;&#25509;&#23383;</span>
        }
</pre>
</div>
</div>
</div>
<div id="outline-container-org7d03941" class="outline-4">
<h4 id="org7d03941"><span class="section-number-4">4.2.4</span> <code>get_line</code></h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
该函数不管行原来是以 \n、\r 还是 \r\n 结束，均转化为以\n 再加\0 字符结束。
</p>
<div class="org-src-container">
<pre class="src src-c">        <span style="color: #00d7af;">int</span> <span style="color: #ffd700;">get_line</span>(<span style="color: #00d7af;">int</span> <span style="color: #ff8700;">sock</span>, <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">buf</span>, <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">size</span>)
        {
            <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">i</span> = 0;
            <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">c</span> = <span style="color: #ff4ea3;">'\0'</span>;
            <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">n</span>;

            <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">http &#35831;&#27714;&#25253;&#25991;&#27599;&#34892;&#37117;&#26159;\r\n &#32467;&#23614; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #a1db00;">while</span> ((i &lt; size - 1) &amp;&amp; (c != <span style="color: #ff4ea3;">'\n'</span>))
            {
                n = recv(sock, &amp;c, 1, 0);

                <span style="color: #a1db00;">if</span> (n &gt; 0)
                {
                    <span style="color: #a1db00;">if</span> (c == <span style="color: #ff4ea3;">'\r'</span>)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#22914;&#26524;&#26159;&#22238;&#36710;&#31526;&#65292;&#32487;&#32493;&#35835;&#21462;</span>
                    {
                        <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">MSG_PEEK &#25506;&#27979;&#19979;&#19968;&#20010;&#23383;&#31526;&#26159;&#19981;&#26159;\n </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
                        n = recv(sock, &amp;c, 1, MSG_PEEK);

                        <span style="color: #a1db00;">if</span> ((n &gt; 0) &amp;&amp; (c == <span style="color: #ff4ea3;">'\n'</span>))<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#22914;&#26524;&#26159;&#22238;&#36710;&#25442;&#34892;&#31526;&#35828;&#26126;&#35835;&#23436;&#19968;&#34892;</span>
                            recv(sock, &amp;c, 1, 0);
                        <span style="color: #a1db00;">else</span>
                            c = <span style="color: #ff4ea3;">'\n'</span>;<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#25442;&#34892;&#26367;&#25442;&#22238;&#36710;&#65292;&#24403;&#20316;&#19968;&#34892;&#36820;&#22238;</span>
                    }
                    buf[i] = c;
                    i++;
                }
                <span style="color: #a1db00;">else</span>
                    c = <span style="color: #ff4ea3;">'\n'</span>;
            }
            buf[i] = <span style="color: #ff4ea3;">'\0'</span>; <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#36820;&#22238;&#19968;&#34892;</span>

            <span style="color: #a1db00;">return</span>(i);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#36820;&#22238;&#35835;&#21040;&#30340;&#23383;&#31526;&#20010;&#25968;(&#21253;&#25324;'\0')</span>
        }
</pre>
</div>
</div>
</div>
<div id="outline-container-org07a1c8d" class="outline-4">
<h4 id="org07a1c8d"><span class="section-number-4">4.2.5</span> <code>execute_cgi</code></h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
主要做的事情就是 fork 一个子进程执行可执行文件，然后通过管道将结果返回父进程，进而返回客户端。
</p>
<ul class="org-ul">
<li>如果是 get 方法，就读取并丢弃整个 http 首部。如果是 post 方法，还会从中 <code>content_length</code> 长度。</li>
<li>建立两个管道， <code>cgi_input</code> 和 <code>cgi_output</code> ，并 fork 一个进程（必须 fork 子进程，pipe 管道才有意义）。建立父子进程间的通信机制。</li>
<li>在子进程中，对其进程下的管道进行重定向，并设置对应的环境变量（method、 <code>query_string</code> 、 <code>content_length</code> ），这些环境变量都是为了给 cgi 脚本调用，接着用 execl 运行 cgi 脚本，可以看出 cgi 脚本的执行在子进程中进行，然后结果通过管道以及重定向返回给父进程。</li>
<li>父进程中，关闭管道一端，如果是 POST 方式，则把 POST 数据写入 <code>cgi_intput</code> ，已被重定向到 STDIN，读取  <code>cgi_output</code> 。 管道输出到客户端（浏览器输出），具体流程图参见上面的管道最终状态图。接着关闭所有管道，等待子进程结束。</li>
<li>关闭连接，完成一次 HTTP 请求与回应。</li>
</ul>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/fork-pipe.png" alt="fork-pipe.png" />
</p>
<p><span class="figure-number">Figure 5: </span>父子进程管道通信</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #00d7af;">void</span> <span style="color: #ffd700;">execute_cgi</span>(<span style="color: #00d7af;">int</span> <span style="color: #ff8700;">client</span>, <span style="color: #a1db00;">const</span> <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">path</span>, <span style="color: #a1db00;">const</span> <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">method</span>, <span style="color: #a1db00;">const</span> <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">query_string</span>)
{
    <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">buf</span>[1024];
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">cgi_output</span>[2];
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">cgi_input</span>[2];
    <span style="color: #00d7af;">pid_t</span> <span style="color: #ff8700;">pid</span>;
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">status</span>;
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">i</span>;
    <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">c</span>;
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">numchars</span> = 1;
    <span style="color: #00d7af;">int</span> <span style="color: #ff8700;">content_length</span> = -1;

    buf[0] = <span style="color: #ff4ea3;">'A'</span>; buf[1] = <span style="color: #ff4ea3;">'\0'</span>;
    <span style="color: #a1db00;">if</span> (strcasecmp(method, <span style="color: #ff4ea3;">"GET"</span>) == 0)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">GET &#26041;&#27861;&#65306;&#19968;&#33324;&#29992;&#20110;&#33719;&#21462;/&#26597;&#35810;&#36164;&#28304;&#20449;&#24687;</span>
        <span style="color: #a1db00;">while</span> ((numchars &gt; 0) &amp;&amp; strcmp(<span style="color: #ff4ea3;">"\n"</span>, buf))  <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">read &amp; discard headers &#35835;&#21462;&#24182;&#20002;&#24323; HTTP &#35831;&#27714; </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            numchars = get_line(client, buf, <span style="color: #a1db00;">sizeof</span>(buf));
    <span style="color: #a1db00;">else</span>    <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">POST &#19968;&#33324;&#29992;&#20110;&#26356;&#26032;&#36164;&#28304;&#20449;&#24687;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
    {
        numchars = get_line(client, buf, <span style="color: #a1db00;">sizeof</span>(buf));

        <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#33719;&#21462; HTTP &#28040;&#24687;&#23454;&#20307;&#30340;&#20256;&#36755;&#38271;&#24230;</span>
        <span style="color: #a1db00;">while</span> ((numchars &gt; 0) &amp;&amp; strcmp(<span style="color: #ff4ea3;">"\n"</span>, buf))<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#19981;&#20026;&#31354;&#19988;&#19981;&#20026;&#25442;&#34892;&#31526;</span>
        {
            buf[15] = <span style="color: #ff4ea3;">'\0'</span>;
            <span style="color: #a1db00;">if</span> (strcasecmp(buf, <span style="color: #ff4ea3;">"Content-Length:"</span>) == 0)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#26159;&#21542;&#20026; Content-Length &#23383;&#27573;</span>
                content_length = atoi(&amp;(buf[16]));<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">Content-Length &#29992;&#20110;&#25551;&#36848; HTTP &#28040;&#24687;&#23454;&#20307;&#30340;&#20256;&#36755;&#38271;&#24230;</span>
            numchars = get_line(client, buf, <span style="color: #a1db00;">sizeof</span>(buf));
        }
        <span style="color: #a1db00;">if</span> (content_length == -1) {
            bad_request(client);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#35831;&#27714;&#30340;&#39029;&#38754;&#25968;&#25454;&#20026;&#31354;&#65292;&#27809;&#26377;&#25968;&#25454;&#65292;&#23601;&#26159;&#25105;&#20204;&#25171;&#24320;&#32593;&#39029;&#32463;&#24120;&#20986;&#29616;&#31354;&#30333;&#39029;&#38754;</span>
            <span style="color: #a1db00;">return</span>;
        }
    }

    sprintf(buf, <span style="color: #ff4ea3;">"HTTP/1.0 200 OK\r\n"</span>);<span style="color: #6c6c6c; font-style: italic;">//</span>
    send(client, buf, strlen(buf), 0);

    <span style="color: #a1db00;">if</span> (pipe(cgi_output) &lt; 0) {
        cannot_execute(client);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#31649;&#36947;&#24314;&#31435;&#22833;&#36133;&#65292;&#25171;&#21360;&#20986;&#38169;&#20449;&#24687;</span>
        <span style="color: #a1db00;">return</span>;
    }
    <span style="color: #a1db00;">if</span> (pipe(cgi_input) &lt; 0) {
        cannot_execute(client);
        <span style="color: #a1db00;">return</span>;
    }

    <span style="color: #a1db00;">if</span> ((pid = fork()) &lt; 0) {
        cannot_execute(client);
        <span style="color: #a1db00;">return</span>;
    }
    <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#23454;&#29616;&#36827;&#31243;&#38388;&#30340;&#31649;&#36947;&#36890;&#20449;&#26426;&#21046;</span>
    <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#23376;&#36827;&#31243;&#32487;&#25215;&#20102;&#29238;&#36827;&#31243;&#30340; pipe&#65292;&#28982;&#21518;&#36890;&#36807;&#20851;&#38381;&#23376;&#36827;&#31243; output &#31649;&#36947;&#30340;&#36755;&#20986;&#31471;&#65292;input &#31649;&#36947;&#30340;&#20889;&#20837;&#31471;&#65307;</span>
<span style="color: #6c6c6c; font-style: italic;">      &#20851;&#38381;&#29238;&#36827;&#31243; output &#31649;&#36947;&#30340;&#20889;&#20837;&#31471;&#65292;input &#31649;&#36947;&#30340;&#36755;&#20986;&#31471;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
    <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#23376;&#36827;&#31243;&#65292;</span>
    <span style="color: #a1db00;">if</span> (pid == 0)  <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">child: CGI script </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
    {
        <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">meth_env</span>[255];
        <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">query_env</span>[255];
        <span style="color: #00d7af;">char</span> <span style="color: #ff8700;">length_env</span>[255];

        <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#22797;&#21046;&#25991;&#20214;&#21477;&#26564;&#65292;&#37325;&#23450;&#21521;&#36827;&#31243;&#30340;&#26631;&#20934;&#36755;&#20837;&#36755;&#20986;</span>
        <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">dup2 &#30340;&#31532;&#19968;&#20010;&#21442;&#25968;&#25551;&#36848;&#31526;&#20851;&#38381;</span>
        dup2(cgi_output[1], 1);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#26631;&#20934;&#36755;&#20986;&#37325;&#23450;&#21521;&#21040; output &#31649;&#36947;&#30340;&#20889;&#20837;&#31471;</span>
        dup2(cgi_input[0], 0);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#26631;&#20934;&#36755;&#20837;&#37325;&#23450;&#21521;&#21040; input &#31649;&#36947;&#30340;&#35835;&#21462;&#31471;</span>
        close(cgi_output[0]);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20851;&#38381; output &#31649;&#36947;&#30340;&#20889;&#20837;&#31471;</span>
        close(cgi_input[1]);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20851;&#38381;&#36755;&#20986;&#31471;</span>
        sprintf(meth_env, <span style="color: #ff4ea3;">"REQUEST_METHOD=%s"</span>, method);
        putenv(meth_env);
        <span style="color: #a1db00;">if</span> (strcasecmp(method, <span style="color: #ff4ea3;">"GET"</span>) == 0) {<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">GET</span>
            <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#35774;&#32622; query_string &#30340;&#29615;&#22659;&#21464;&#37327;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            sprintf(query_env, <span style="color: #ff4ea3;">"QUERY_STRING=%s"</span>, query_string);
            putenv(query_env);
        }
        <span style="color: #a1db00;">else</span> {   <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">POST </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#35774;&#32622; content_length &#30340;&#29615;&#22659;&#21464;&#37327;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            sprintf(length_env, <span style="color: #ff4ea3;">"CONTENT_LENGTH=%d"</span>, content_length);
            putenv(length_env);
        }
        execl(path, path, <span style="color: #5fafd7;">NULL</span>);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">exec &#20989;&#25968;&#31751;&#65292;&#25191;&#34892; CGI &#33050;&#26412;&#65292;&#33719;&#21462; cgi &#30340;&#26631;&#20934;&#36755;&#20986;&#20316;&#20026;&#30456;&#24212;&#20869;&#23481;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;</span>
        <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#36890;&#36807; dup2 &#37325;&#23450;&#21521;&#65292;&#26631;&#20934;&#36755;&#20986;&#20869;&#23481;&#36827;&#20837;&#31649;&#36947; output &#30340;&#36755;&#20837;&#31471;</span>

        exit(0);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#23376;&#36827;&#31243;&#36864;&#20986;</span>
    }
    <span style="color: #a1db00;">else</span> {    <span style="color: #6c6c6c; font-style: italic;">/* </span><span style="color: #6c6c6c; font-style: italic;">parent </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        close(cgi_output[1]);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20851;&#38381;&#31649;&#36947;&#30340;&#19968;&#31471;&#65292;&#36825;&#26679;&#21487;&#20197;&#24314;&#31435;&#29238;&#23376;&#36827;&#31243;&#38388;&#30340;&#31649;&#36947;&#36890;&#20449;</span>
        close(cgi_input[0]);
        <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#36890;&#36807;&#20851;&#38381;&#23545;&#24212;&#31649;&#36947;&#30340;&#36890;&#36947;&#65292;&#28982;&#21518;&#37325;&#23450;&#21521;&#23376;&#36827;&#31243;&#30340;&#31649;&#36947;&#26576;&#31471;&#65292;&#36825;&#26679;&#23601;&#22312;&#29238;&#23376;&#36827;&#31243;&#20043;&#38388;&#26500;&#24314;&#19968;&#26465;&#21333;&#21452;&#24037;&#36890;&#36947;</span>
<span style="color: #6c6c6c; font-style: italic;">          &#22914;&#26524;&#19981;&#37325;&#23450;&#21521;&#65292;&#23558;&#26159;&#19968;&#26465;&#20856;&#22411;&#30340;&#20840;&#21452;&#24037;&#31649;&#36947;&#36890;&#20449;&#26426;&#21046;</span>
<span style="color: #6c6c6c; font-style: italic;">        </span><span style="color: #6c6c6c; font-style: italic;">*/</span>
        <span style="color: #a1db00;">if</span> (strcasecmp(method, <span style="color: #ff4ea3;">"POST"</span>) == 0)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">POST &#26041;&#24335;&#65292;&#23558;&#25351;&#23450;&#22909;&#30340;&#20256;&#36755;&#38271;&#24230;&#23383;&#31526;&#21457;&#36865;</span>
            <span style="color: #6c6c6c; font-style: italic;">/*</span><span style="color: #6c6c6c; font-style: italic;">&#25509;&#25910; POST &#36807;&#26469;&#30340;&#25968;&#25454;</span><span style="color: #6c6c6c; font-style: italic;">*/</span>
            <span style="color: #a1db00;">for</span> (i = 0; i &lt; content_length; i++) {
                recv(client, &amp;c, 1, 0);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20174;&#23458;&#25143;&#31471;&#25509;&#25910;&#21333;&#20010;&#23383;&#31526;</span>
                write(cgi_input[1], &amp;c, 1);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20889;&#20837; input&#65292;&#28982;&#21518;&#37325;&#23450;&#21521;&#21040;&#20102;&#26631;&#20934;&#36755;&#20837;</span>
                <span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#25968;&#25454;&#20256;&#36865;&#36807;&#31243;&#65306;input[1](&#29238;&#36827;&#31243;) &#8212;&#8212;&gt; input[0](&#23376;&#36827;&#31243;)[&#25191;&#34892; cgi &#20989;&#25968;] &#8212;&#8212;&gt; STDIN &#8212;&#8212;&gt; STDOUT</span>
                <span style="color: #6c6c6c; font-style: italic;">// </span><span style="color: #6c6c6c; font-style: italic;">&#8212;&#8212;&gt; output[1](&#23376;&#36827;&#31243;) &#8212;&#8212;&gt; output[0](&#29238;&#36827;&#31243;)[&#23558;&#32467;&#26524;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;]</span>

            }
        <span style="color: #a1db00;">while</span> (read(cgi_output[0], &amp;c, 1) &gt; 0)<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#35835;&#21462; output &#30340;&#31649;&#36947;&#36755;&#20986;&#21040;&#23458;&#25143;&#31471;&#65292;output &#36755;&#20986;&#31471;&#20026; cgi &#33050;&#26412;&#25191;&#34892;&#21518;&#30340;&#20869;&#23481;</span>
            send(client, &amp;c, 1, 0);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#21363;&#23558; cgi &#25191;&#34892;&#32467;&#26524;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;&#65292;&#21363; send &#21040;&#27983;&#35272;&#22120;&#65292;&#22914;&#26524;&#19981;&#26159; POST &#21017;&#21482;&#26377;&#36825;&#19968;&#22788;&#29702;</span>

        close(cgi_output[0]);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#20851;&#38381;&#21097;&#19979;&#30340;&#31649;&#36947;&#31471;&#65292;&#23376;&#36827;&#31243;&#22312;&#25191;&#34892; dup2 &#20043;&#21518;&#65292;&#23601;&#24050;&#32463;&#20851;&#38381;&#20102;&#31649;&#36947;&#19968;&#31471;&#36890;&#36947;</span>
        close(cgi_input[1]);
        waitpid(pid, &amp;status, 0);<span style="color: #6c6c6c; font-style: italic;">//</span><span style="color: #6c6c6c; font-style: italic;">&#31561;&#24453;&#23376;&#36827;&#31243;&#32456;&#27490;</span>
    }
}
</pre>
</div>
<p>
index.html 页面的输入框是使用的 post 方法，那么我们动手使用使用 get 方法也应该。但是 color.cgi 没有实现这个功能，我们用 shell 脚本来执行试试。
</p>

<div class="org-src-container">
<pre class="src src-bash">      <span style="color: #6c6c6c; font-style: italic;">#</span><span style="color: #6c6c6c; font-style: italic;">!/bin/sh</span>
      <span style="color: #d18aff;">echo</span> <span style="color: #ff4ea3;">"Content-type:text/html"</span>
      <span style="color: #d18aff;">echo</span>
      <span style="color: #d18aff;">echo</span> <span style="color: #ff4ea3;">'&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;MyTitle&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor="'</span> $<span style="color: #ff8700;">0</span> <span style="color: #ff4ea3;">'"&gt;'</span>
      <span style="color: #6c6c6c; font-style: italic;">#</span><span style="color: #6c6c6c; font-style: italic;">$0 &#36825;&#20010;&#21442;&#25968;&#20256;&#36882;&#30340;&#21548;&#24618;&#24322;&#30340;&#65292;&#20027;&#35201;&#26159; execl &#20989;&#25968;&#27809;&#20889;&#22909;&#65292;&#25042;&#24471;&#25913;&#20102;</span>
      <span style="color: #d18aff;">echo</span> <span style="color: #ff4ea3;">"&lt;/body&gt;&lt;/html&gt;"</span>
</pre>
</div>
<p>
返回一个我们设置颜色的页面，注意要加 test.sh 添加执行权限，才会被视为执行 cgi 程序来执行。
</p>
<div class="org-src-container">
<pre class="src src-bash">chmod +x tinyhttpd-0.1.0/htdocs/test.sh
</pre>
</div>

<p>
当在浏览器中直接输入 <code>localhost:12345/test.sh?red</code>
</p>

<p>
服务器作出的响应。
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/cgi-test-sh.png" alt="cgi-test-sh.png" />
</p>
<p><span class="figure-number">Figure 6: </span>cgi test.sh 运行</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org7a17757" class="outline-2">
<h2 id="org7a17757"><span class="section-number-2">5</span> 附录</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org2593fc9" class="outline-3">
<h3 id="org2593fc9"><span class="section-number-3">5.1</span> HTTP 报文格式</h3>
<div class="outline-text-3" id="text-5-1">
<p>
HTTP 有两种报文：请求报文和响应报文，具体介绍如下
</p>
</div>
<div id="outline-container-org3b44d58" class="outline-4">
<h4 id="org3b44d58"><span class="section-number-4">5.1.1</span> 请求报文</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
一个 HTTP 请求报文由请求行（request line）、请求头部（header）、空行和请求数据 4 个部分组成，下图给出了请求报文的一般格式。
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/http-request-format.png" alt="http-request-format.png" />
</p>
<p><span class="figure-number">Figure 7: </span>HTTP 请求报文格式</p>
</div>

<ul class="org-ul">
<li><p>
请求行
</p>

<p>
请求行由请求方法字段、URL 字段和 HTTP 协议版本字段 3 个字段组成，它们用空格分隔。例如，GET /index.html HTTP/1.1。
</p>

<p>
HTTP 协议的请求方法有 GET、POST、HEAD、PUT、DELETE、OPTIONS、TRACE、CONNECT。这里介绍最常用的 GET 方法和 POST 方法。
</p>

<p>
GET：当客户端要从服务器中读取文档时，使用 GET 方法。GET 方法要求服务器将 URL 定位的资源放在响应报文的数据部分，回送给客户端。使用 GET 方法时，请求参数和对应的值附加在 URL 后面，利用一个问号（“?”）代表 URL 的结尾与请求参数的开始，传递参数长度受限制。例如，/index.jsp?id=100&amp;op=bind。
</p></li>
</ul>

<p>
POST：当客户端给服务器提供信息较多时可以使用 POST 方法。POST 方法将请求参数封装在 HTTP 请求数据中，以名称 / 值的形式出现，可以传输大量数据。
</p>

<p>
协议版本的格式为：HTTP / 主版本号. 次版本号，常用的有 HTTP/1.0 和 HTTP/1.1。
</p>

<ul class="org-ul">
<li><p>
请求头部
</p>

<p>
请求头部由关键字 / 值对组成，每行一对，关键字和值用英文冒号 “:” 分隔。请求头部通知服务器有关于客户端请求的信息。常见请求头如下：
</p>
<ul class="org-ul">
<li>Host 接受请求的服务器地址，可以是 IP: 端口号，也可以是域名</li>
<li>User-Agent 发送请求的应用程序名称</li>
<li>Connection 指定与连接相关的属性，如 Connection:Keep-Alive</li>
<li>Accept-Charset 通知服务端可以发送的编码格式</li>
<li>Accept-Encoding 通知服务端可以发送的数据压缩格式</li>
<li>Accept-Language 通知服务端可以发送的语言</li>
</ul></li>

<li><p>
空行
</p>

<p>
最后一个请求头之后是一个空行，发送回车符和换行符，通知服务器以下不再有请求头。
</p></li>

<li><p>
请求数据
</p>

<p>
请求数据不在 GET 方法中使用，而是在 POST 方法中使用。POST 方法适用于需要客户填写表单的场合。与请求数据相关的最常使用的请求头是 Content-Type 和 Content-Length。
</p></li>
</ul>


<div class="figure">
<p><img src="../img/tinyhttpd-analysis/http-get-request.png" alt="http-get-request.png" />
</p>
<p><span class="figure-number">Figure 8: </span>GET 请求示例</p>
</div>


<div class="figure">
<p><img src="../img/tinyhttpd-analysis/http-post-request.png" alt="http-post-request.png" />
</p>
<p><span class="figure-number">Figure 9: </span>POST 请求示例</p>
</div>
</div>
</div>

<div id="outline-container-orgbc8c982" class="outline-4">
<h4 id="orgbc8c982"><span class="section-number-4">5.1.2</span> 响应报文</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
HTTP 响应报文主要由状态行、响应头部、响应正文 3 部分组成。
</p>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/http-response-format.png" alt="http-response-format.png" />
</p>
<p><span class="figure-number">Figure 10: </span>HTTP 响应报文格式</p>
</div>

<ul class="org-ul">
<li><p>
状态行
</p>

<p>
状态行由 3 部分组成，分别为：协议版本，状态码，状态码描述，之间由空格分隔。状态代码为 3 位数字，200~299 的状态码表示成功，300~399 的状态码指资源重定向，400~499 的状态码指客户端请求出错，500~599 的状态码指服务端出错（HTTP/1.1 向协议中引入了信息性状态码，范围为 100~199）。这里列举几个常见的：
</p>
<ul class="org-ul">
<li>200：响应成功</li>
<li>302：跳转，跳转地址通过响应头中的 Location 属性指定（JSP 中 Forward 和 Redirect 之间的区别）</li>
<li>400：客户端请求有语法错误，不能被服务器识别</li>
<li>403：服务器接收到请求，但是拒绝提供服务（认证失败）</li>
<li>404：请求资源不存在</li>
<li>500：服务器内部错误</li>
</ul></li>

<li><p>
响应头部
</p>

<p>
与请求头部类似，为响应报文添加了一些附加信息。常见响应头部如下：
</p>
<ul class="org-ul">
<li>Server：服务器应用程序软件的名称和版本</li>
<li>Content-Type：响应正文的类型（是图片还是二进制字符串）</li>
<li>Content-Length：响应正文长度</li>
<li>Content-Charset：响应正文使用的编码</li>
<li>Content-Encoding：响应正文使用的数据压缩格式</li>
<li>Content-Language：响应正文使用的语言</li>
</ul></li>
</ul>

<div class="figure">
<p><img src="../img/tinyhttpd-analysis/http-response.png" alt="http-response.png" />
</p>
<p><span class="figure-number">Figure 11: </span>HTTP 响应示例</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org0a075c3" class="outline-3">
<h3 id="org0a075c3"><span class="section-number-3">5.2</span> 换行、回车</h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-org7f684d3" class="outline-4">
<h4 id="org7f684d3"><span class="section-number-4">5.2.1</span> 历史</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
这里主要介绍“回车”（carriage return \r）和 “换行”（line feed \n）这两个概念的来历和区别。
</p>

<p>
在计算机还没有出现之前，有一种叫做电传打字机（Teletype Model 33）的玩意，每秒钟可以打 10 个字符。但是它有一个问题，就是打完一行换行的时候，要用去 0.2 秒，正好可以打两个字符。要是在这 0.2 秒里面，又有新的字符传过来，那么这个字符将丢失。
</p>

<p>
于是，研制人员想了个办法解决这个问题，就是在每行后面加两个表示结束的字符。一个叫做 “回车”，告诉打字机把打印头定位在左边界；另一个叫做 “换行”，告诉打字机把纸向下移一行。这就是 “换行” 和 “回车” 的来历，从它们的英语名字上也可以看出一二。
</p>

<p>
后来，计算机发明了，这两个概念也就被般到了计算机上。那时，存储器很贵，一些科学家认为在每行结尾加两个字符太浪费了，加一个就可以。于是，就出现了分歧：Unix 系统里，每行结尾只有 “&lt;换行&gt;（\n）”；Windows 系统里面，每行结尾是 “&lt;换行&gt;&lt;回车&gt;（\n\r）”，Mac 系统里，每行结尾是 “&lt;回车&gt;（\r）”。一个直接后果是，Unix/Mac 系统下的文件在 Windows 里打 开的话，所有文字会变成一行；而 Windows 里的文件在 Unix/Mac 下打开的话，在每行的结尾可能会多出一个 ^M 符号。
</p>

<p>
c 语言编程时(linux) \r 就是回到本行行首，这就会把这一行以前的输出覆盖掉。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d18aff;">#include</span> <span style="color: #ff4ea3;">&lt;stdio.h&gt;</span>
<span style="color: #00d7af;">int</span> <span style="color: #ffd700;">main</span>(<span style="color: #00d7af;">int</span> <span style="color: #ff8700;">argc</span>, <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">argv</span>[])
{
    printf(<span style="color: #ff4ea3;">"hahahaha\rxixixi"</span>);
    <span style="color: #a1db00;">return</span> 0;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #d18aff;">cd</span> ~/projects/org-notes/org/source-code-analysis/tinyhttpd-analysis/
make
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">./printf-ret
</pre>
</div>
<p>
TODO: 上面代码段在 export 时候没有正确输出结果，tty 上面没有问题，需要检查。
</p>
<pre class="example">
xixixi
</pre>
<p>
最后只显示 xixi，而 hahaha 被覆盖了。
</p>

<p>
\n 是回车＋换行，把光标先移到行首，然后换到下一行，也就是下一行的行首。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d18aff;">#include</span> <span style="color: #ff4ea3;">&lt;stdio.h&gt;</span>
<span style="color: #00d7af;">int</span> <span style="color: #ffd700;">main</span>(<span style="color: #00d7af;">int</span> <span style="color: #ff8700;">argc</span>, <span style="color: #00d7af;">char</span> *<span style="color: #ff8700;">argv</span>[])
{
    printf(<span style="color: #ff4ea3;">"hahaha\nxixi\n"</span>);
    <span style="color: #a1db00;">return</span> 0;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">make
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">./printf-newline
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="http://tinyhttpd.sourceforge.net/">Tinyhttpd homepage</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<a href="http://blog.csdn.net/baiwfg2/article/details/45582723">tinyhttpd 源码详解</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<a href="http://blog.csdn.net/wenqian1991/article/details/46011357">TinyHTTPd&#x2013; 超轻量型 Http Server 源码分析</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
<a href="http://techlog.cn/article/list/10182680">超轻量服务器 tinyhttpd 源码解析</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: liushangliang</p>
<p class="email">Email: <a href="mailto:phenix3443+github@gmail.com">phenix3443+github@gmail.com</a></p>
<p class="date">Created: 2020-04-26 日 10:53</p>
<p class="validation"></p>
</div>
</body>
</html>
