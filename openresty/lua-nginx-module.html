<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-10 二 19:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>lua-nginx-module</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="liushangliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript" src="./script/org-info.js">

<script type="text/javascript" src="https://orgmode.org/org-info.js">
/**
 *
 * @source: https://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in https://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2019 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in https://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "https://phenix3443.github.io/");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://phenix3443.github.io/"> HOME </a>
</div><div id="content">
<h1 class="title">lua-nginx-module</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org53368d1">1. 概述</a></li>
<li><a href="#org97e87aa">2. 安装</a></li>
<li><a href="#org606b429">3. Directives</a>
<ul>
<li><a href="#org8e98a6c">3.1. lua_capture_error_log</a></li>
<li><a href="#orgca4ae1d">3.2. lua_use_default_type</a></li>
<li><a href="#org8f2b34f">3.3. lua_malloc_trim</a></li>
<li><a href="#org603e6d4">3.4. lua_code_cache</a></li>
<li><a href="#org41f7214">3.5. lua_regex_cache_max_entries</a></li>
<li><a href="#orgcc0213f">3.6. lua_regex_match_limit</a></li>
<li><a href="#orge3145f8">3.7. lua_package_path</a></li>
<li><a href="#org9ce2c79">3.8. lua_package_cpath</a></li>
<li><a href="#org48e757f">3.9. init_by_lua</a></li>
<li><a href="#org740b4e9">3.10. init_by_lua_block</a></li>
<li><a href="#orgd355dbd">3.11. init_by_lua_file</a></li>
<li><a href="#org294fcbd">3.12. init_worker_by_lua</a></li>
<li><a href="#org67723f3">3.13. init_worker_by_lua_block</a></li>
<li><a href="#org84de2a0">3.14. init_worker_by_lua_file</a></li>
<li><a href="#orgad5de0c">3.15. set_by_lua</a></li>
<li><a href="#orgcd3373a">3.16. set_by_lua_block</a></li>
<li><a href="#org03c8cfe">3.17. set_by_lua_file</a></li>
<li><a href="#org736918c">3.18. content_by_lua</a></li>
<li><a href="#orgfa21470">3.19. content_by_lua_block</a></li>
<li><a href="#orgd2fe6f1">3.20. content_by_lua_file</a></li>
<li><a href="#org905f292">3.21. rewrite_by_lua</a></li>
<li><a href="#orge229972">3.22. rewrite_by_lua_block</a></li>
<li><a href="#orgb8872f6">3.23. rewrite_by_lua_file</a></li>
<li><a href="#org1fa2042">3.24. access_by_lua</a></li>
<li><a href="#org49da82a">3.25. access_by_lua_block</a></li>
<li><a href="#org5be3850">3.26. access_by_lua_file</a></li>
<li><a href="#orgca6f08d">3.27. header_filter_by_lua</a></li>
<li><a href="#orgb903669">3.28. header_filter_by_lua_block</a></li>
<li><a href="#org363dc42">3.29. header_filter_by_lua_file</a></li>
<li><a href="#org5c525a2">3.30. body_filter_by_lua</a></li>
<li><a href="#org660ea7f">3.31. body_filter_by_lua_block</a></li>
<li><a href="#orgb36968b">3.32. body_filter_by_lua_file</a></li>
<li><a href="#org889d974">3.33. log_by_lua</a></li>
<li><a href="#orgbe8e6ce">3.34. log_by_lua_block</a></li>
<li><a href="#orgd4f9955">3.35. log_by_lua_file</a></li>
<li><a href="#org3c6bf82">3.36. balancer_by_lua_block</a></li>
<li><a href="#orgcf40a42">3.37. balancer_by_lua_file</a></li>
<li><a href="#org15d7560">3.38. lua_need_request_body</a></li>
<li><a href="#orgfdf5713">3.39. ssl_certificate_by_lua_block</a></li>
<li><a href="#orga271b8f">3.40. ssl_certificate_by_lua_file</a></li>
<li><a href="#org5e87f5c">3.41. ssl_session_fetch_by_lua_block</a></li>
<li><a href="#org857f476">3.42. ssl_session_fetch_by_lua_file</a></li>
<li><a href="#org14fa1a9">3.43. ssl_session_store_by_lua_block</a></li>
<li><a href="#org8f35a7c">3.44. ssl_session_store_by_lua_file</a></li>
<li><a href="#org2ba7f00">3.45. lua_shared_dict</a></li>
<li><a href="#orgcbebc12">3.46. lua_socket_connect_timeout</a></li>
<li><a href="#org3eb9782">3.47. lua_socket_send_timeout</a></li>
<li><a href="#orgb45b8fc">3.48. lua_socket_send_lowat</a></li>
<li><a href="#orge9272e4">3.49. lua_socket_read_timeout</a></li>
<li><a href="#org0785ed9">3.50. lua_socket_buffer_size</a></li>
<li><a href="#orgd6851e2">3.51. lua_socket_pool_size</a></li>
<li><a href="#org507b2bd">3.52. lua_socket_keepalive_timeout</a></li>
<li><a href="#orgb8d259f">3.53. lua_socket_log_errors</a></li>
<li><a href="#org7388c54">3.54. lua_ssl_ciphers</a></li>
<li><a href="#org596499a">3.55. lua_ssl_crl</a></li>
<li><a href="#org6eb1fad">3.56. lua_ssl_protocols</a></li>
<li><a href="#org868970c">3.57. lua_ssl_trusted_certificate</a></li>
<li><a href="#orgc604e8b">3.58. lua_ssl_verify_depth</a></li>
<li><a href="#org4a1ffab">3.59. lua_http10_buffering</a></li>
<li><a href="#orgc6fbe00">3.60. rewrite_by_lua_no_postpone</a></li>
<li><a href="#org100bfef">3.61. access_by_lua_no_postpone</a></li>
<li><a href="#org9b5e8d2">3.62. lua_transform_underscores_in_response_headers</a></li>
<li><a href="#org4a4306c">3.63. lua_check_client_abort</a></li>
<li><a href="#org45cc87d">3.64. lua_max_pending_timers</a></li>
<li><a href="#orgefe6bda">3.65. lua_max_running_timers</a></li>
</ul>
</li>
<li><a href="#org5140011">4. Nginx API for Lua</a>
<ul>
<li><a href="#orgada772d">4.1. Introduction</a></li>
<li><a href="#orge85825c">4.2. ngx.arg</a></li>
<li><a href="#orgbec2e22">4.3. ngx.var.VARIABLE</a></li>
<li><a href="#org26a5976">4.4. Core constants</a></li>
<li><a href="#org2d6b779">4.5. HTTP method constants</a></li>
<li><a href="#org1204816">4.6. HTTP status constants</a></li>
<li><a href="#org3e7556a">4.7. Nginx log level constants</a></li>
<li><a href="#org2fe5a4e">4.8. print</a></li>
<li><a href="#org1125323">4.9. ngx.ctx</a></li>
<li><a href="#org81f26ed">4.10. ngx.location.capture</a></li>
<li><a href="#org69e5e25">4.11. ngx.location.capture_multi</a></li>
<li><a href="#org1acb26a">4.12. ngx.status</a></li>
<li><a href="#org7d07247">4.13. ngx.header.HEADER</a></li>
<li><a href="#org6b53c30">4.14. ngx.resp.get_headers</a></li>
<li><a href="#org86c32a9">4.15. ngx.req.is_internal</a></li>
<li><a href="#org63df65d">4.16. ngx.req.start_time</a></li>
<li><a href="#orgad07397">4.17. ngx.req.http_version</a></li>
<li><a href="#org0f5faa3">4.18. ngx.req.raw_header</a></li>
<li><a href="#orgc2665f8">4.19. ngx.req.get_method</a></li>
<li><a href="#org65619b1">4.20. ngx.req.set_method</a></li>
<li><a href="#orgeee1262">4.21. ngx.req.set_uri</a></li>
<li><a href="#orgae1020a">4.22. ngx.req.set_uri_args</a></li>
<li><a href="#org4ba91ce">4.23. ngx.req.get_uri_args</a></li>
<li><a href="#org3d9274b">4.24. ngx.req.get_post_args</a></li>
<li><a href="#orgd4e04a7">4.25. ngx.req.get_headers</a></li>
<li><a href="#org78af3a5">4.26. ngx.req.set_header</a></li>
<li><a href="#org9d45c7d">4.27. ngx.req.clear_header</a></li>
<li><a href="#org7a29107">4.28. ngx.req.read_body</a></li>
<li><a href="#org48f6dec">4.29. ngx.req.discard_body</a></li>
<li><a href="#org2de4681">4.30. ngx.req.get_body_data</a></li>
<li><a href="#org21dab4b">4.31. ngx.req.get_body_file</a></li>
<li><a href="#orge8d796f">4.32. ngx.req.set_body_data</a></li>
<li><a href="#org03d246e">4.33. ngx.req.set_body_file</a></li>
<li><a href="#org4f7268a">4.34. ngx.req.init_body</a></li>
<li><a href="#orgb1414c0">4.35. ngx.req.append_body</a></li>
<li><a href="#orgb27f9ff">4.36. ngx.req.finish_body</a></li>
<li><a href="#org0ef5f70">4.37. ngx.req.socket</a></li>
<li><a href="#orgd37056f">4.38. ngx.exec</a></li>
<li><a href="#orga950967">4.39. ngx.redirect</a></li>
<li><a href="#org964187c">4.40. ngx.send_headers</a></li>
<li><a href="#orgcd0ed1a">4.41. ngx.headers_sent</a></li>
<li><a href="#orgeab46d9">4.42. ngx.print</a></li>
<li><a href="#orgf8d4d58">4.43. ngx.say</a></li>
<li><a href="#orgf08a7a6">4.44. ngx.log</a></li>
<li><a href="#org773f8bc">4.45. ngx.flush</a></li>
<li><a href="#orgee1a128">4.46. ngx.exit</a></li>
<li><a href="#orgbf0af60">4.47. ngx.eof</a></li>
<li><a href="#org40c838f">4.48. ngx.sleep</a></li>
<li><a href="#orgefd3f55">4.49. ngx.escape_uri</a></li>
<li><a href="#org73c7277">4.50. ngx.unescape_uri</a></li>
<li><a href="#org2647755">4.51. ngx.encode_args</a></li>
<li><a href="#org38b7673">4.52. ngx.decode_args</a></li>
<li><a href="#orgb112370">4.53. ngx.encode_base64</a></li>
<li><a href="#org1179877">4.54. ngx.decode_base64</a></li>
<li><a href="#orga9c5be7">4.55. ngx.crc32_short</a></li>
<li><a href="#org713524d">4.56. ngx.crc32_long</a></li>
<li><a href="#org16afabc">4.57. ngx.hmac_sha1</a></li>
<li><a href="#orgcc01002">4.58. ngx.md5</a></li>
<li><a href="#org2bacfbb">4.59. ngx.md5_bin</a></li>
<li><a href="#org0264de3">4.60. ngx.sha1_bin</a></li>
<li><a href="#org9b919ce">4.61. ngx.quote_sql_str</a></li>
<li><a href="#org110ca8c">4.62. ngx.today</a></li>
<li><a href="#orga287d4b">4.63. ngx.time</a></li>
<li><a href="#org695c7d2">4.64. ngx.now</a></li>
<li><a href="#orgd392533">4.65. ngx.update_time</a></li>
<li><a href="#orgbbb96b7">4.66. ngx.localtime</a></li>
<li><a href="#org3e0e4ea">4.67. ngx.utctime</a></li>
<li><a href="#org005a878">4.68. ngx.cookie_time</a></li>
<li><a href="#orgdc02fc9">4.69. ngx.http_time</a></li>
<li><a href="#orgfcd2167">4.70. ngx.parse_http_time</a></li>
<li><a href="#orgb05b1f8">4.71. ngx.is_subrequest</a></li>
<li><a href="#org3a8c001">4.72. ngx.re.match</a></li>
<li><a href="#org257c2c3">4.73. ngx.re.find</a></li>
<li><a href="#orgcfd219b">4.74. ngx.re.gmatch</a></li>
<li><a href="#org03142e6">4.75. ngx.re.sub</a></li>
<li><a href="#orgc919263">4.76. ngx.re.gsub</a></li>
<li><a href="#org66318d3">4.77. ngx.shared.DICT</a></li>
<li><a href="#orgdb3f8fb">4.78. ngx.shared.DICT.get</a></li>
<li><a href="#org78f8193">4.79. ngx.shared.DICT.get_stale</a></li>
<li><a href="#org8c4a6bb">4.80. ngx.shared.DICT.set</a></li>
<li><a href="#orgbab06a5">4.81. ngx.shared.DICT.safe_set</a></li>
<li><a href="#org936766b">4.82. ngx.shared.DICT.add</a></li>
<li><a href="#org16f63a7">4.83. ngx.shared.DICT.safe_add</a></li>
<li><a href="#org718336a">4.84. ngx.shared.DICT.replace</a></li>
<li><a href="#orge02d296">4.85. ngx.shared.DICT.delete</a></li>
<li><a href="#org7f71f93">4.86. ngx.shared.DICT.incr</a></li>
<li><a href="#orgf90c52a">4.87. ngx.shared.DICT.lpush</a></li>
<li><a href="#orgfb34b8a">4.88. ngx.shared.DICT.rpush</a></li>
<li><a href="#org36d9ab0">4.89. ngx.shared.DICT.lpop</a></li>
<li><a href="#org4930e78">4.90. ngx.shared.DICT.rpop</a></li>
<li><a href="#orgc624dc9">4.91. ngx.shared.DICT.llen</a></li>
<li><a href="#orgabc1182">4.92. ngx.shared.DICT.ttl</a></li>
<li><a href="#org4615f19">4.93. ngx.shared.DICT.expire</a></li>
<li><a href="#org6981aff">4.94. ngx.shared.DICT.flush_all</a></li>
<li><a href="#org60b5c67">4.95. ngx.shared.DICT.flush_expired</a></li>
<li><a href="#orgdbed527">4.96. ngx.shared.DICT.get_keys</a></li>
<li><a href="#orgc97f8c0">4.97. ngx.shared.DICT.capacity</a></li>
<li><a href="#orgd58fc9e">4.98. ngx.shared.DICT.free_space</a></li>
<li><a href="#org3f470d5">4.99. ngx.socket.udp</a></li>
<li><a href="#orge0b9ec2">4.100. udpsock:setpeername</a></li>
<li><a href="#org915a07e">4.101. udpsock:send</a></li>
<li><a href="#orgda9c700">4.102. udpsock:receive</a></li>
<li><a href="#org5a9ca69">4.103. udpsock:close</a></li>
<li><a href="#org8a3b965">4.104. udpsock:settimeout</a></li>
<li><a href="#org9c134ac">4.105. ngx.socket.stream</a></li>
<li><a href="#org7f7a9fa">4.106. ngx.socket.tcp</a></li>
<li><a href="#orge712211">4.107. tcpsock:connect</a></li>
<li><a href="#org2fcbbca">4.108. tcpsock:sslhandshake</a></li>
<li><a href="#orgfbe3403">4.109. tcpsock:send</a></li>
<li><a href="#orgd110f70">4.110. tcpsock:receive</a></li>
<li><a href="#orgda8e305">4.111. tcpsock:receiveany</a></li>
<li><a href="#orgd79abd9">4.112. tcpsock:receiveuntil</a></li>
<li><a href="#orgd1fe997">4.113. tcpsock:close</a></li>
<li><a href="#orgced7222">4.114. tcpsock:settimeout</a></li>
<li><a href="#orgc206412">4.115. tcpsock:settimeouts</a></li>
<li><a href="#org0f19a80">4.116. tcpsock:setoption</a></li>
<li><a href="#org2f31339">4.117. tcpsock:setkeepalive</a></li>
<li><a href="#orgcfabf39">4.118. tcpsock:getreusedtimes</a></li>
<li><a href="#orge117107">4.119. ngx.socket.connect</a></li>
<li><a href="#org8e62699">4.120. ngx.get_phase</a></li>
<li><a href="#org90a086d">4.121. ngx.thread.spawn</a></li>
<li><a href="#orge2d3da8">4.122. ngx.thread.wait</a></li>
<li><a href="#org7b7a029">4.123. ngx.thread.kill</a></li>
<li><a href="#org178e703">4.124. ngx.on_abort</a></li>
<li><a href="#org3da00c6">4.125. ngx.timer.at</a></li>
<li><a href="#org0059440">4.126. ngx.timer.every</a></li>
<li><a href="#org169ad83">4.127. ngx.timer.running_count</a></li>
<li><a href="#orgb1d110d">4.128. ngx.timer.pending_count</a></li>
<li><a href="#org7a9a4a8">4.129. ngx.config.subsystem</a></li>
<li><a href="#orgd9e09b0">4.130. ngx.config.debug</a></li>
<li><a href="#org76ba007">4.131. ngx.config.prefix</a></li>
<li><a href="#org47e1c53">4.132. ngx.config.nginx_version</a></li>
<li><a href="#org1be66d1">4.133. ngx.config.nginx_configure</a></li>
<li><a href="#org8b0c06a">4.134. ngx.config.ngx_lua_version</a></li>
<li><a href="#org43e1f43">4.135. ngx.worker.exiting</a></li>
<li><a href="#org7d01937">4.136. ngx.worker.pid</a></li>
<li><a href="#org4df25b2">4.137. ngx.worker.count</a></li>
<li><a href="#org4850919">4.138. ngx.worker.id</a></li>
<li><a href="#org6476588">4.139. ngx.semaphore</a></li>
<li><a href="#org9d05bc7">4.140. ngx.balancer</a></li>
<li><a href="#orgae540c5">4.141. ngx.ssl</a></li>
<li><a href="#orgc835f06">4.142. ngx.ocsp</a></li>
<li><a href="#org79e1a78">4.143. ndk.set_var.DIRECTIVE</a></li>
<li><a href="#org5e5e5d6">4.144. coroutine.create</a></li>
<li><a href="#org6a40f35">4.145. coroutine.resume</a></li>
<li><a href="#org141cb6a">4.146. coroutine.yield</a></li>
<li><a href="#org4000a9b">4.147. coroutine.wrap</a></li>
<li><a href="#org6e4efd3">4.148. coroutine.running</a></li>
<li><a href="#org46e3a29">4.149. coroutine.status</a></li>
</ul>
</li>
<li><a href="#org7d6d19e">5. Known Issues</a>
<ul>
<li><a href="#org99a8b1e">5.1. Data Sharing within an Nginx Worker</a></li>
<li><a href="#org3046197">5.2. Lua Variable Scope</a></li>
<li><a href="#org981c9b6">5.3. Cosockets Not Available Everywhere</a></li>
<li><a href="#org228724b">5.4. Special Escaping Sequences</a></li>
</ul>
</li>
<li><a href="#org611d38e">6. third-party</a>
<ul>
<li><a href="#org5b7809a">6.1. lua-resty-string</a></li>
<li><a href="#org78429ba">6.2. lua-resty-logger-socket</a></li>
<li><a href="#org89bae80">6.3. lua-resty-mysql</a></li>
<li><a href="#orgcdb2e9e">6.4. lua-resty-redis</a></li>
<li><a href="#orgf1729e2">6.5. lua-resty-upload</a></li>
<li><a href="#org5aee7fc">6.6. lua-resty-cookie</a></li>
<li><a href="#org80eb7e3">6.7. stream-lua-nginx-module</a></li>
<li><a href="#org469dd08">6.8. openresty-systemtap-toolkit</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org53368d1" class="outline-2">
<h2 id="org53368d1"><span class="section-number-2">1</span> 概述<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></h2>
<div class="outline-text-2" id="text-1">
<p>
Lua-nginx-module 将 Lua 集成到 NginX 中，并提供高并发和非阻塞请求处理能力，而无需强制开发人员明确地将业务逻辑划分为状态机。开发人员可以用简单的顺序方式编写程序，而 lua-nginx-module 将在可阻塞的 I/O 操作中自动中断程序逻辑，保存上下文，并将这些 I/O 操作委托给 NginX 的事件机制。完成 I/O 操作后，lua-nginx-module 将恢复上下文并恢复程序逻辑。用户程序本身会像往常一样感觉到从未被打断过。
</p>

<p>
Lua-nginx-module 使用 one-coroutine-per-request 请求处理模型，即对于每个传入请求，lua-nginx-module 创建一个协程来处理请求，协程将在请求处理完成后销毁。
</p>

<p>
每个协程都有自己独立的全局环境，它继承了共享的只读公共数据。因此，用户代码注入的任何全局值都不会影响其他请求的处理，并且在请求处理完成时将被释放。您可以想象用户代码在 “沙箱” 中运行，该沙箱与请求本身共享相同的生命周期。通过这种方式，lua-nginx-module 可以防止因滥用用户代码中的全局值而导致的内存泄漏，从而提高健壮性。
</p>

<p>
受益于 Lua 卓越的协程支持，lua-nginx-module 可以以极低的内存开销处理数万个并发请求。根据我们的测试，如果使用 LuaJIT，lua-nginx-module 中每个请求的内存开销仅为 2 KB 甚至更小。显然，lua-nginx-module 是实现广泛并发服务的良好候选者。
</p>

<p>
与 Apache 的 mod_lua 和 Lighttpd 的 mod_magnet 不同，只要使用该模块提供的 Lua 的 Nginx API 处理 MySQL，PostgreSQL，Memcached，Redis 或 HTTP Web 服务 等上游服务的请求，使用此模块执行的 Lua 代码在网络传输就是 100％无阻塞的。
</p>

<p>
几乎所有 Nginx 模块都可以通过 ngx.location.capture 或 ngx.location.capture_multi 与此 ngx_lua 模块一起使用，但建议使用那些 <code>lua-resty-*</code> 库，而不是创建子请求来访问 Nginx 上游模块，因为前者通常更灵活，内存效率更高。
</p>

<p>
Lua 解释器或 LuaJIT 实例在单个 nginx 工作进程中的所有请求之间共享，但请求上下文使用轻量级 Lua 协程进行隔离。
</p>

<p>
加载的 Lua 模块在 nginx 工作进程级别中持续存在，所以，即使负载很重的情况下，Lua 代码内存占用量很小。
</p>

<p>
该模块插入 NGINX 的 “http” 子系统，因此它使用 HTTP 系列中的下游通信协议（HTTP 0.9/1.0/1.1/2.0，WebSockets 等）。 如果要使用 TCP 与下游客户端进行通信，则应使用具有兼容 Lua API 的 ngx_stream_lua 模块。
</p>
</div>
</div>

<div id="outline-container-org97e87aa" class="outline-2">
<h2 id="org97e87aa"><span class="section-number-2">2</span> 安装</h2>
<div class="outline-text-2" id="text-2">
<p>
强烈建议使用集成 Nginx，ngx_lua，LuaJIT 2.1 以及其他强大的配套 Nginx 模块和 Lua 库的 OpenResty 版本。 不鼓励用 nginx 自己构建这个模块，因为设置完全正确是很棘手的。
</p>

<p>
手动编参考<a href="https://github.com/openresty/lua-nginx-module#installation">Installation</a>
</p>
</div>
</div>

<div id="outline-container-org606b429" class="outline-2">
<h2 id="org606b429"><span class="section-number-2">3</span> Directives</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org8e98a6c" class="outline-3">
<h3 id="org8e98a6c"><span class="section-number-3">3.1</span> lua_capture_error_log</h3>
</div>
<div id="outline-container-orgca4ae1d" class="outline-3">
<h3 id="orgca4ae1d"><span class="section-number-3">3.2</span> lua_use_default_type</h3>
</div>
<div id="outline-container-org8f2b34f" class="outline-3">
<h3 id="org8f2b34f"><span class="section-number-3">3.3</span> lua_malloc_trim</h3>
</div>
<div id="outline-container-org603e6d4" class="outline-3">
<h3 id="org603e6d4"><span class="section-number-3">3.4</span> lua_code_cache</h3>
<div class="outline-text-3" id="text-3-4">
<p>
在 *_by_lua_file 指令（如 set_by_lua_file 和 content_by_lua_file）和 Lua 模块中启用或禁用 Lua 代码的 Lua 代码缓存。
</p>

<p>
关闭时，从 0.9.3 版本开始，ngx_lua 处理的每个请求都将在单独的 Lua VM 实例中运行。因此，set_by_lua_file，content_by_lua_file，access_by_lua_file 等中引用的 Lua 文件不会被缓存，所有使用的 Lua 模块都将从头开始加载。有了这个，开发人员可以编辑代码后可以不用重新加载代码。
</p>

<p>
但是请注意，在 nginx.conf 中编写内联的 Lua 代码（如 set_by_lua，content_by_lua，access_by_lua 和 rewrite_by_lua 指定的内容），在编辑后不会更新，因为只有 Nginx 配置文件解析器可以正确解析 nginx.conf 文件，唯一的方法是通过发送 HUP 信号重新加载配置文件或重新启动 Nginx。
</p>

<p>
即使启用了代码缓存，也无法缓存由 *_by_lua_file 中的 dofile 或 loadfile 加载的 Lua 文件（除非您自己缓存结果）。通常可以使用 init_by_lua 或 init_by_lua_file 指令加载所有这些文件，或者让这些 Lua 文件成为真正的 Lua 模块并通过 require 加载它们。
</p>

<p>
ngx_lua 模块不支持 Apache mod_lua 模块可用的 stat 模式。
</p>

<p>
强烈不推荐在生产环境中禁用 Lua 代码缓存，该功能只应在开发期间使用，因为它会对整体性能产生显著的负面影响。例如，在禁用 Lua 代码缓存后，“hello world” Lua 示例的性能可能会下降一个数量级。
</p>
</div>
</div>

<div id="outline-container-org41f7214" class="outline-3">
<h3 id="org41f7214"><span class="section-number-3">3.5</span> lua_regex_cache_max_entries</h3>
</div>
<div id="outline-container-orgcc0213f" class="outline-3">
<h3 id="orgcc0213f"><span class="section-number-3">3.6</span> lua_regex_match_limit</h3>
</div>
<div id="outline-container-orge3145f8" class="outline-3">
<h3 id="orge3145f8"><span class="section-number-3">3.7</span> lua_package_path</h3>
</div>
<div id="outline-container-org9ce2c79" class="outline-3">
<h3 id="org9ce2c79"><span class="section-number-3">3.8</span> lua_package_cpath</h3>
</div>
<div id="outline-container-org48e757f" class="outline-3">
<h3 id="org48e757f"><span class="section-number-3">3.9</span> init_by_lua</h3>
<div class="outline-text-3" id="text-3-9">
<p>
当 Nginx 主进程加载 Nginx 配置文件时，在全局 Lua VM 级别运行由参数&lt;lua-script-str&gt;指定的 Lua 代码。
</p>

<p>
当 Nginx 收到 HUP 信号并开始重新加载配置文件时，Lua VM 也将被重新创建，init_by_lua 将在新的 Lua VM 上再次运行。 如果关闭 lua_code_cache 指令（默认打开），init_by_lua 处理程序将在每个请求时运行，因为在此特殊模式下，始终为每个请求创建一个独立的 Lua VM。
</p>

<p>
通常，可以通过 hook 在服务器启动时预加载 Lua 模块，因为此上下文中的 Lua 代码在 Nginx fork 其工作进程（如果有）之前运行，所以此处加载的数据或代码将享受许多操作系统提供的写时复制（COW）功能，从而节省了很多内存。
</p>

<p>
不要在此上下文中初始化自己的 Lua 全局变量，因为使用 Lua 全局变量会导致性能损失，并可能导致全局命名空间污染。 推荐的方法是使用正确的 Lua 模块文件（但不要使用标准的 module()来定义 Lua 模块，因为它也会污染全局命名空间），并调用 require() 来在 init_by_lua 或其他上下文中加载您自己的模块文件（require()会将加载的 Lua 模块缓存在 Lua 注册表中的全局 package.loaded 表中，这样该模块对于整个 Lua VM 实例加载一次）。
</p>
</div>
</div>

<div id="outline-container-org740b4e9" class="outline-3">
<h3 id="org740b4e9"><span class="section-number-3">3.10</span> init_by_lua_block</h3>
</div>
<div id="outline-container-orgd355dbd" class="outline-3">
<h3 id="orgd355dbd"><span class="section-number-3">3.11</span> init_by_lua_file</h3>
</div>
<div id="outline-container-org294fcbd" class="outline-3">
<h3 id="org294fcbd"><span class="section-number-3">3.12</span> init_worker_by_lua</h3>
<div class="outline-text-3" id="text-3-12">
<p>
启用主进程时，在每个 Nginx 工作进程启动时运行指定的 Lua 代码。 当主进程被禁用时，将在 <code>init_by_lua*</code> 之后运行。
</p>

<p>
此挂钩通常用于创建每个 worker 重复发生的计时器（通过 ngx.timer.at），用于后端运行状况检查或其他定时例行工作。
</p>

<p>
思考：
</p>
<ul class="org-ul">
<li><p>
该指令与 init_by_lua 有何不同？
</p>

<p>
init_by_lua 主要声明公共模块。
</p></li>

<li><p>
为什么不能在 init_by_lua 中初始化定时器？
</p>

<p>
因为 fork 的时候不能 fork 定时器。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org67723f3" class="outline-3">
<h3 id="org67723f3"><span class="section-number-3">3.13</span> init_worker_by_lua_block</h3>
</div>
<div id="outline-container-org84de2a0" class="outline-3">
<h3 id="org84de2a0"><span class="section-number-3">3.14</span> init_worker_by_lua_file</h3>
</div>
<div id="outline-container-orgad5de0c" class="outline-3">
<h3 id="orgad5de0c"><span class="section-number-3">3.15</span> set_by_lua</h3>
</div>
<div id="outline-container-orgcd3373a" class="outline-3">
<h3 id="orgcd3373a"><span class="section-number-3">3.16</span> set_by_lua_block</h3>
</div>
<div id="outline-container-org03c8cfe" class="outline-3">
<h3 id="org03c8cfe"><span class="section-number-3">3.17</span> set_by_lua_file</h3>
</div>
<div id="outline-container-org736918c" class="outline-3">
<h3 id="org736918c"><span class="section-number-3">3.18</span> content_by_lua</h3>
</div>
<div id="outline-container-orgfa21470" class="outline-3">
<h3 id="orgfa21470"><span class="section-number-3">3.19</span> content_by_lua_block</h3>
</div>
<div id="outline-container-orgd2fe6f1" class="outline-3">
<h3 id="orgd2fe6f1"><span class="section-number-3">3.20</span> content_by_lua_file</h3>
</div>
<div id="outline-container-org905f292" class="outline-3">
<h3 id="org905f292"><span class="section-number-3">3.21</span> rewrite_by_lua</h3>
</div>
<div id="outline-container-orge229972" class="outline-3">
<h3 id="orge229972"><span class="section-number-3">3.22</span> rewrite_by_lua_block</h3>
</div>
<div id="outline-container-orgb8872f6" class="outline-3">
<h3 id="orgb8872f6"><span class="section-number-3">3.23</span> rewrite_by_lua_file</h3>
</div>
<div id="outline-container-org1fa2042" class="outline-3">
<h3 id="org1fa2042"><span class="section-number-3">3.24</span> access_by_lua</h3>
<div class="outline-text-3" id="text-3-24">
<p>
请注意，此处理程序始终在标准 ngx_http_access_module 之后运行。
</p>

<p>
与其他访问阶段处理程序一样，access_by_lua 不会在子请求中运行。
</p>

<p>
请注意，在 access_by_lua 处理程序中调用 ngx.exit（ngx.OK）时，nginx 请求处理控制流仍将继续到内容处理程序。 要从 access_by_lua 处理程序中终止当前请求，成功退出请调用 ngx.exit(status) （200(ngx.HTTP_OK)&lt;= status&lt;300(ngx.HTTP_SPECIAL_RESPONSE)），失败退出请调用 ngx.exit（ngx.HTTP_INTERNAL_SERVER_ERROR）（或其其他类似）。
</p>
</div>
</div>

<div id="outline-container-org49da82a" class="outline-3">
<h3 id="org49da82a"><span class="section-number-3">3.25</span> access_by_lua_block</h3>
</div>
<div id="outline-container-org5be3850" class="outline-3">
<h3 id="org5be3850"><span class="section-number-3">3.26</span> access_by_lua_file</h3>
</div>
<div id="outline-container-orgca6f08d" class="outline-3">
<h3 id="orgca6f08d"><span class="section-number-3">3.27</span> header_filter_by_lua</h3>
<div class="outline-text-3" id="text-3-27">
<p>
用来定义输出的 header 过滤器。
</p>
</div>
</div>

<div id="outline-container-orgb903669" class="outline-3">
<h3 id="orgb903669"><span class="section-number-3">3.28</span> header_filter_by_lua_block</h3>
</div>
<div id="outline-container-org363dc42" class="outline-3">
<h3 id="org363dc42"><span class="section-number-3">3.29</span> header_filter_by_lua_file</h3>
</div>
<div id="outline-container-org5c525a2" class="outline-3">
<h3 id="org5c525a2"><span class="section-number-3">3.30</span> body_filter_by_lua</h3>
</div>
<div id="outline-container-org660ea7f" class="outline-3">
<h3 id="org660ea7f"><span class="section-number-3">3.31</span> body_filter_by_lua_block</h3>
</div>
<div id="outline-container-orgb36968b" class="outline-3">
<h3 id="orgb36968b"><span class="section-number-3">3.32</span> body_filter_by_lua_file</h3>
</div>
<div id="outline-container-org889d974" class="outline-3">
<h3 id="org889d974"><span class="section-number-3">3.33</span> log_by_lua</h3>
<div class="outline-text-3" id="text-3-33">
<p>
在 v0.9.17 版本之后，不鼓励使用此指令。 请改用 log_by_lua_block 指令。
</p>

<p>
在日志请求处理阶段运行作为 &lt;lua-script-str&gt; 内联的 Lua 源代码。这不会替换当前的访问日志，而是先与其运行。
</p>

<p>
请注意，此上下文中当前禁用了以下 API 函数：
</p>
<ul class="org-ul">
<li>输出 API 函数（例如，ngx.say 和 ngx.send_headers）</li>
<li>控制 API 函数（例如，ngx.exit）</li>
<li>子请求 API 函数（例如，ngx.location.capture 和 ngx.location.capture_multi）</li>
<li>Cosocket API 函数（例如，ngx.socket.tcp 和 ngx.req.socket）。</li>
</ul>
</div>
</div>

<div id="outline-container-orgbe8e6ce" class="outline-3">
<h3 id="orgbe8e6ce"><span class="section-number-3">3.34</span> log_by_lua_block</h3>
</div>
<div id="outline-container-orgd4f9955" class="outline-3">
<h3 id="orgd4f9955"><span class="section-number-3">3.35</span> log_by_lua_file</h3>
</div>
<div id="outline-container-org3c6bf82" class="outline-3">
<h3 id="org3c6bf82"><span class="section-number-3">3.36</span> balancer_by_lua_block</h3>
</div>
<div id="outline-container-orgcf40a42" class="outline-3">
<h3 id="orgcf40a42"><span class="section-number-3">3.37</span> balancer_by_lua_file</h3>
</div>
<div id="outline-container-org15d7560" class="outline-3">
<h3 id="org15d7560"><span class="section-number-3">3.38</span> lua_need_request_body</h3>
</div>
<div id="outline-container-orgfdf5713" class="outline-3">
<h3 id="orgfdf5713"><span class="section-number-3">3.39</span> ssl_certificate_by_lua_block</h3>
</div>
<div id="outline-container-orga271b8f" class="outline-3">
<h3 id="orga271b8f"><span class="section-number-3">3.40</span> ssl_certificate_by_lua_file</h3>
</div>
<div id="outline-container-org5e87f5c" class="outline-3">
<h3 id="org5e87f5c"><span class="section-number-3">3.41</span> ssl_session_fetch_by_lua_block</h3>
</div>
<div id="outline-container-org857f476" class="outline-3">
<h3 id="org857f476"><span class="section-number-3">3.42</span> ssl_session_fetch_by_lua_file</h3>
</div>
<div id="outline-container-org14fa1a9" class="outline-3">
<h3 id="org14fa1a9"><span class="section-number-3">3.43</span> ssl_session_store_by_lua_block</h3>
</div>
<div id="outline-container-org8f35a7c" class="outline-3">
<h3 id="org8f35a7c"><span class="section-number-3">3.44</span> ssl_session_store_by_lua_file</h3>
</div>
<div id="outline-container-org2ba7f00" class="outline-3">
<h3 id="org2ba7f00"><span class="section-number-3">3.45</span> lua_shared_dict</h3>
</div>
<div id="outline-container-orgcbebc12" class="outline-3">
<h3 id="orgcbebc12"><span class="section-number-3">3.46</span> lua_socket_connect_timeout</h3>
</div>
<div id="outline-container-org3eb9782" class="outline-3">
<h3 id="org3eb9782"><span class="section-number-3">3.47</span> lua_socket_send_timeout</h3>
</div>
<div id="outline-container-orgb45b8fc" class="outline-3">
<h3 id="orgb45b8fc"><span class="section-number-3">3.48</span> lua_socket_send_lowat</h3>
</div>
<div id="outline-container-orge9272e4" class="outline-3">
<h3 id="orge9272e4"><span class="section-number-3">3.49</span> lua_socket_read_timeout</h3>
</div>
<div id="outline-container-org0785ed9" class="outline-3">
<h3 id="org0785ed9"><span class="section-number-3">3.50</span> lua_socket_buffer_size</h3>
</div>
<div id="outline-container-orgd6851e2" class="outline-3">
<h3 id="orgd6851e2"><span class="section-number-3">3.51</span> lua_socket_pool_size</h3>
</div>
<div id="outline-container-org507b2bd" class="outline-3">
<h3 id="org507b2bd"><span class="section-number-3">3.52</span> lua_socket_keepalive_timeout</h3>
</div>
<div id="outline-container-orgb8d259f" class="outline-3">
<h3 id="orgb8d259f"><span class="section-number-3">3.53</span> lua_socket_log_errors</h3>
</div>
<div id="outline-container-org7388c54" class="outline-3">
<h3 id="org7388c54"><span class="section-number-3">3.54</span> lua_ssl_ciphers</h3>
</div>
<div id="outline-container-org596499a" class="outline-3">
<h3 id="org596499a"><span class="section-number-3">3.55</span> lua_ssl_crl</h3>
</div>
<div id="outline-container-org6eb1fad" class="outline-3">
<h3 id="org6eb1fad"><span class="section-number-3">3.56</span> lua_ssl_protocols</h3>
</div>
<div id="outline-container-org868970c" class="outline-3">
<h3 id="org868970c"><span class="section-number-3">3.57</span> lua_ssl_trusted_certificate</h3>
</div>
<div id="outline-container-orgc604e8b" class="outline-3">
<h3 id="orgc604e8b"><span class="section-number-3">3.58</span> lua_ssl_verify_depth</h3>
</div>
<div id="outline-container-org4a1ffab" class="outline-3">
<h3 id="org4a1ffab"><span class="section-number-3">3.59</span> lua_http10_buffering</h3>
</div>
<div id="outline-container-orgc6fbe00" class="outline-3">
<h3 id="orgc6fbe00"><span class="section-number-3">3.60</span> rewrite_by_lua_no_postpone</h3>
</div>
<div id="outline-container-org100bfef" class="outline-3">
<h3 id="org100bfef"><span class="section-number-3">3.61</span> access_by_lua_no_postpone</h3>
</div>
<div id="outline-container-org9b5e8d2" class="outline-3">
<h3 id="org9b5e8d2"><span class="section-number-3">3.62</span> lua_transform_underscores_in_response_headers</h3>
</div>
<div id="outline-container-org4a4306c" class="outline-3">
<h3 id="org4a4306c"><span class="section-number-3">3.63</span> lua_check_client_abort</h3>
</div>
<div id="outline-container-org45cc87d" class="outline-3">
<h3 id="org45cc87d"><span class="section-number-3">3.64</span> lua_max_pending_timers</h3>
</div>
<div id="outline-container-orgefe6bda" class="outline-3">
<h3 id="orgefe6bda"><span class="section-number-3">3.65</span> lua_max_running_timers</h3>
</div>
</div>

<div id="outline-container-org5140011" class="outline-2">
<h2 id="org5140011"><span class="section-number-2">4</span> Nginx API for Lua</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgada772d" class="outline-3">
<h3 id="orgada772d"><span class="section-number-3">4.1</span> Introduction</h3>
<div class="outline-text-3" id="text-4-1">
<p>
用户代码中的网络 I/O 操作应该只通过 Nginx Lua API 调用来完成，因为 Nginx 事件循环可能会被阻止，这样性能会急剧下降。 相对少量数据的磁盘操作可以使用标准 Lua io 库完成，但应尽可能避免大量文件读取和写入，因为它们可能会显着阻止 Nginx 进程。 为了获得最佳性能，强烈建议将所有网络和磁盘 I/O 操作委派给 Nginx 的子请求（通过 ngx.location.capture 方法和类似方法）。
</p>
</div>
</div>

<div id="outline-container-orge85825c" class="outline-3">
<h3 id="orge85825c"><span class="section-number-3">4.2</span> ngx.arg</h3>
</div>
<div id="outline-container-orgbec2e22" class="outline-3">
<h3 id="orgbec2e22"><span class="section-number-3">4.3</span> ngx.var.VARIABLE</h3>
<div class="outline-text-3" id="text-4-3">
<p>
用来读写 nginx 变量值。
</p>

<p>
请注意，只能写入已定义的 nginx 变量。
</p>

<p>
小心：从 Nginx 变量读取时，Nginx 将在每个请求内存池中分配内存，该内存池仅在请求终止时释放。 因此，当需要在 Lua 代码中重复读取 Nginx 变量时，将 Nginx 变量值缓存到自己的 Lua 变量中，例如，
</p>
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #a1db00;">local</span> <span style="color: #ff8700;">val</span> = ngx.var.some_var
 <span style="color: #6c6c6c; font-style: italic;">--- </span><span style="color: #6c6c6c; font-style: italic;">use the val repeatedly later</span>
</pre>
</div>
<p>
防止（临时）内存在当前请求的生命周期内泄漏。 缓存结果的另一种方法是使用 ngx.ctx 表。
</p>

<p>
此 API 需要相对昂贵的元方法调用，建议避免在热代码路径上使用它。
</p>

<p>
不要处于 worker 级别的数据共享，在 module 级别将 ngx.ctx 赋值给本地变量。
</p>
</div>
</div>

<div id="outline-container-org26a5976" class="outline-3">
<h3 id="org26a5976"><span class="section-number-3">4.4</span> Core constants</h3>
<div class="outline-text-3" id="text-4-4">
<p>
ngx.null 常量是一个 NULL light userdata，通常用于表示 Lua 表等中的 nil 值，类似于 lua-cjson 库的 cjson.null 常量。
</p>
</div>
</div>

<div id="outline-container-org2d6b779" class="outline-3">
<h3 id="org2d6b779"><span class="section-number-3">4.5</span> HTTP method constants</h3>
</div>
<div id="outline-container-org1204816" class="outline-3">
<h3 id="org1204816"><span class="section-number-3">4.6</span> HTTP status constants</h3>
</div>
<div id="outline-container-org3e7556a" class="outline-3">
<h3 id="org3e7556a"><span class="section-number-3">4.7</span> Nginx log level constants</h3>
</div>
<div id="outline-container-org2fe5a4e" class="outline-3">
<h3 id="org2fe5a4e"><span class="section-number-3">4.8</span> print</h3>
</div>
<div id="outline-container-org1125323" class="outline-3">
<h3 id="org1125323"><span class="section-number-3">4.9</span> ngx.ctx</h3>
<div class="outline-text-3" id="text-4-9">
<p>
此表可用于存储每个请求的 Lua 上下文数据，并具有与当前请求相同的生命周期（与 Nginx 变量一样）。
</p>

<p>
每个请求（包括子请求）都有自己的表 <b>副本</b> 。
</p>

<p>
内部重定向将销毁原始请求 ngx.ctx 数据（如果有），新请求将具有空的 ngx.ctx 表。
</p>

<p>
ngx.ctx 查找需要相对昂贵的元方法调用，并且比通过您自己的函数参数显式传递每个请求数据要慢得多。 因此，不要滥用此 API 来保存自己的函数参数，因为它通常会对性能产生很大的影响。
</p>
</div>
</div>

<div id="outline-container-org81f26ed" class="outline-3">
<h3 id="org81f26ed"><span class="section-number-3">4.10</span> ngx.location.capture</h3>
<div class="outline-text-3" id="text-4-10">
<p>
发出同步但仍无阻塞的 Nginx 子请求。
</p>

<p>
另请注意，子请求只是模仿 HTTP 接口，但没有额外的 HTTP / TCP 流量，也没有涉及 IPC。一切都在内部，高效，在 C 级别上运作。
</p>

<p>
请注意，ngx.location.capture 发出的子请求默认会继承当前请求的所有请求头部，这可能会对子请求响应产生意外的副作用。在子请求位置将 proxy_pass_request_headers 设为 off 可忽略原始请求头。
</p>

<p>
每个主要请求可能存在的并发子请求数存在硬编码上限。 在旧版本的 Nginx 中，限制是 50 个并发子请求，而在更新版本中，Nginx 1.1.x 以上，这增加到 200 个并发子请求。 超出此限制时，将在 error.log 文件中添加以下错误消息：
</p>
<pre class="example">
[error] 13983#0: *1 subrequests cycle while processing "/uri"
</pre>
</div>
</div>


<div id="outline-container-org69e5e25" class="outline-3">
<h3 id="org69e5e25"><span class="section-number-3">4.11</span> ngx.location.capture_multi</h3>
</div>
<div id="outline-container-org1acb26a" class="outline-3">
<h3 id="org1acb26a"><span class="section-number-3">4.12</span> ngx.status</h3>
<div class="outline-text-3" id="text-4-12">
<p>
读取和写入当前请求的响应状态。 应该在发送响应头之前调用它。
</p>
</div>
</div>
<div id="outline-container-org7d07247" class="outline-3">
<h3 id="org7d07247"><span class="section-number-3">4.13</span> ngx.header.HEADER</h3>
</div>
<div id="outline-container-org6b53c30" class="outline-3">
<h3 id="org6b53c30"><span class="section-number-3">4.14</span> ngx.resp.get_headers</h3>
</div>
<div id="outline-container-org86c32a9" class="outline-3">
<h3 id="org86c32a9"><span class="section-number-3">4.15</span> ngx.req.is_internal</h3>
</div>
<div id="outline-container-org63df65d" class="outline-3">
<h3 id="org63df65d"><span class="section-number-3">4.16</span> ngx.req.start_time</h3>
<div class="outline-text-3" id="text-4-16">
<p>
返回一个浮点数，表示创建当前请求时的时间戳（包括作为小数部分的毫秒数）。
</p>

<p>
以下示例在纯 Lua 中模拟 <code>$request_time</code> 变量值（由 ngx_http_log_module 提供）：
</p>

<div class="org-src-container">
<pre class="src src-lua"><span style="color: #a1db00;">local</span> <span style="color: #ff8700;">request_time</span> = ngx.now() - ngx.req.start_time()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgad07397" class="outline-3">
<h3 id="orgad07397"><span class="section-number-3">4.17</span> ngx.req.http_version</h3>
</div>
<div id="outline-container-org0f5faa3" class="outline-3">
<h3 id="org0f5faa3"><span class="section-number-3">4.18</span> ngx.req.raw_header</h3>
</div>
<div id="outline-container-orgc2665f8" class="outline-3">
<h3 id="orgc2665f8"><span class="section-number-3">4.19</span> ngx.req.get_method</h3>
</div>
<div id="outline-container-org65619b1" class="outline-3">
<h3 id="org65619b1"><span class="section-number-3">4.20</span> ngx.req.set_method</h3>
</div>
<div id="outline-container-orgeee1262" class="outline-3">
<h3 id="orgeee1262"><span class="section-number-3">4.21</span> ngx.req.set_uri</h3>
</div>
<div id="outline-container-orgae1020a" class="outline-3">
<h3 id="orgae1020a"><span class="section-number-3">4.22</span> ngx.req.set_uri_args</h3>
</div>
<div id="outline-container-org4ba91ce" class="outline-3">
<h3 id="org4ba91ce"><span class="section-number-3">4.23</span> ngx.req.get_uri_args</h3>
</div>
<div id="outline-container-org3d9274b" class="outline-3">
<h3 id="org3d9274b"><span class="section-number-3">4.24</span> ngx.req.get_post_args</h3>
</div>
<div id="outline-container-orgd4e04a7" class="outline-3">
<h3 id="orgd4e04a7"><span class="section-number-3">4.25</span> ngx.req.get_headers</h3>
</div>
<div id="outline-container-org78af3a5" class="outline-3">
<h3 id="org78af3a5"><span class="section-number-3">4.26</span> ngx.req.set_header</h3>
</div>
<div id="outline-container-org9d45c7d" class="outline-3">
<h3 id="org9d45c7d"><span class="section-number-3">4.27</span> ngx.req.clear_header</h3>
</div>
<div id="outline-container-org7a29107" class="outline-3">
<h3 id="org7a29107"><span class="section-number-3">4.28</span> ngx.req.read_body</h3>
</div>
<div id="outline-container-org48f6dec" class="outline-3">
<h3 id="org48f6dec"><span class="section-number-3">4.29</span> ngx.req.discard_body</h3>
</div>
<div id="outline-container-org2de4681" class="outline-3">
<h3 id="org2de4681"><span class="section-number-3">4.30</span> ngx.req.get_body_data</h3>
</div>
<div id="outline-container-org21dab4b" class="outline-3">
<h3 id="org21dab4b"><span class="section-number-3">4.31</span> ngx.req.get_body_file</h3>
</div>
<div id="outline-container-orge8d796f" class="outline-3">
<h3 id="orge8d796f"><span class="section-number-3">4.32</span> ngx.req.set_body_data</h3>
</div>
<div id="outline-container-org03d246e" class="outline-3">
<h3 id="org03d246e"><span class="section-number-3">4.33</span> ngx.req.set_body_file</h3>
</div>
<div id="outline-container-org4f7268a" class="outline-3">
<h3 id="org4f7268a"><span class="section-number-3">4.34</span> ngx.req.init_body</h3>
</div>
<div id="outline-container-orgb1414c0" class="outline-3">
<h3 id="orgb1414c0"><span class="section-number-3">4.35</span> ngx.req.append_body</h3>
</div>
<div id="outline-container-orgb27f9ff" class="outline-3">
<h3 id="orgb27f9ff"><span class="section-number-3">4.36</span> ngx.req.finish_body</h3>
</div>
<div id="outline-container-org0ef5f70" class="outline-3">
<h3 id="org0ef5f70"><span class="section-number-3">4.37</span> ngx.req.socket</h3>
</div>
<div id="outline-container-orgd37056f" class="outline-3">
<h3 id="orgd37056f"><span class="section-number-3">4.38</span> ngx.exec</h3>
</div>
<div id="outline-container-orga950967" class="outline-3">
<h3 id="orga950967"><span class="section-number-3">4.39</span> ngx.redirect</h3>
</div>
<div id="outline-container-org964187c" class="outline-3">
<h3 id="org964187c"><span class="section-number-3">4.40</span> ngx.send_headers</h3>
</div>
<div id="outline-container-orgcd0ed1a" class="outline-3">
<h3 id="orgcd0ed1a"><span class="section-number-3">4.41</span> ngx.headers_sent</h3>
</div>
<div id="outline-container-orgeab46d9" class="outline-3">
<h3 id="orgeab46d9"><span class="section-number-3">4.42</span> ngx.print</h3>
</div>
<div id="outline-container-orgf8d4d58" class="outline-3">
<h3 id="orgf8d4d58"><span class="section-number-3">4.43</span> ngx.say</h3>
</div>
<div id="outline-container-orgf08a7a6" class="outline-3">
<h3 id="orgf08a7a6"><span class="section-number-3">4.44</span> ngx.log</h3>
</div>
<div id="outline-container-org773f8bc" class="outline-3">
<h3 id="org773f8bc"><span class="section-number-3">4.45</span> ngx.flush</h3>
</div>
<div id="outline-container-orgee1a128" class="outline-3">
<h3 id="orgee1a128"><span class="section-number-3">4.46</span> ngx.exit</h3>
</div>
<div id="outline-container-orgbf0af60" class="outline-3">
<h3 id="orgbf0af60"><span class="section-number-3">4.47</span> ngx.eof</h3>
</div>
<div id="outline-container-org40c838f" class="outline-3">
<h3 id="org40c838f"><span class="section-number-3">4.48</span> ngx.sleep</h3>
</div>
<div id="outline-container-orgefd3f55" class="outline-3">
<h3 id="orgefd3f55"><span class="section-number-3">4.49</span> ngx.escape_uri</h3>
</div>
<div id="outline-container-org73c7277" class="outline-3">
<h3 id="org73c7277"><span class="section-number-3">4.50</span> ngx.unescape_uri</h3>
</div>
<div id="outline-container-org2647755" class="outline-3">
<h3 id="org2647755"><span class="section-number-3">4.51</span> ngx.encode_args</h3>
</div>
<div id="outline-container-org38b7673" class="outline-3">
<h3 id="org38b7673"><span class="section-number-3">4.52</span> ngx.decode_args</h3>
</div>
<div id="outline-container-orgb112370" class="outline-3">
<h3 id="orgb112370"><span class="section-number-3">4.53</span> ngx.encode_base64</h3>
</div>
<div id="outline-container-org1179877" class="outline-3">
<h3 id="org1179877"><span class="section-number-3">4.54</span> ngx.decode_base64</h3>
</div>
<div id="outline-container-orga9c5be7" class="outline-3">
<h3 id="orga9c5be7"><span class="section-number-3">4.55</span> ngx.crc32_short</h3>
</div>
<div id="outline-container-org713524d" class="outline-3">
<h3 id="org713524d"><span class="section-number-3">4.56</span> ngx.crc32_long</h3>
</div>
<div id="outline-container-org16afabc" class="outline-3">
<h3 id="org16afabc"><span class="section-number-3">4.57</span> ngx.hmac_sha1</h3>
</div>
<div id="outline-container-orgcc01002" class="outline-3">
<h3 id="orgcc01002"><span class="section-number-3">4.58</span> ngx.md5</h3>
</div>
<div id="outline-container-org2bacfbb" class="outline-3">
<h3 id="org2bacfbb"><span class="section-number-3">4.59</span> ngx.md5_bin</h3>
</div>
<div id="outline-container-org0264de3" class="outline-3">
<h3 id="org0264de3"><span class="section-number-3">4.60</span> ngx.sha1_bin</h3>
</div>
<div id="outline-container-org9b919ce" class="outline-3">
<h3 id="org9b919ce"><span class="section-number-3">4.61</span> ngx.quote_sql_str</h3>
</div>
<div id="outline-container-org110ca8c" class="outline-3">
<h3 id="org110ca8c"><span class="section-number-3">4.62</span> ngx.today</h3>
</div>
<div id="outline-container-orga287d4b" class="outline-3">
<h3 id="orga287d4b"><span class="section-number-3">4.63</span> ngx.time</h3>
<div class="outline-text-3" id="text-4-63">
<p>
从 nginx 缓存时间返回当前时间戳记的纪元的经过 <b>秒数</b> （与 Lua 的日期库不同，不涉及系统调用）。
</p>
</div>
</div>
<div id="outline-container-org695c7d2" class="outline-3">
<h3 id="org695c7d2"><span class="section-number-3">4.64</span> ngx.now</h3>
<div class="outline-text-3" id="text-4-64">
<p>
从 nginx 缓存时间返回从当前时间戳的纪元开始的经过时间（包括作为小数部分的毫秒）的 <b>浮点数</b> （与 Lua 的日期库不同，不涉及系统调用）。
</p>
</div>
</div>

<div id="outline-container-orgd392533" class="outline-3">
<h3 id="orgd392533"><span class="section-number-3">4.65</span> ngx.update_time</h3>
</div>
<div id="outline-container-orgbbb96b7" class="outline-3">
<h3 id="orgbbb96b7"><span class="section-number-3">4.66</span> ngx.localtime</h3>
</div>
<div id="outline-container-org3e0e4ea" class="outline-3">
<h3 id="org3e0e4ea"><span class="section-number-3">4.67</span> ngx.utctime</h3>
</div>
<div id="outline-container-org005a878" class="outline-3">
<h3 id="org005a878"><span class="section-number-3">4.68</span> ngx.cookie_time</h3>
</div>
<div id="outline-container-orgdc02fc9" class="outline-3">
<h3 id="orgdc02fc9"><span class="section-number-3">4.69</span> ngx.http_time</h3>
</div>
<div id="outline-container-orgfcd2167" class="outline-3">
<h3 id="orgfcd2167"><span class="section-number-3">4.70</span> ngx.parse_http_time</h3>
</div>
<div id="outline-container-orgb05b1f8" class="outline-3">
<h3 id="orgb05b1f8"><span class="section-number-3">4.71</span> ngx.is_subrequest</h3>
</div>
<div id="outline-container-org3a8c001" class="outline-3">
<h3 id="org3a8c001"><span class="section-number-3">4.72</span> ngx.re.match</h3>
</div>
<div id="outline-container-org257c2c3" class="outline-3">
<h3 id="org257c2c3"><span class="section-number-3">4.73</span> ngx.re.find</h3>
</div>
<div id="outline-container-orgcfd219b" class="outline-3">
<h3 id="orgcfd219b"><span class="section-number-3">4.74</span> ngx.re.gmatch</h3>
</div>
<div id="outline-container-org03142e6" class="outline-3">
<h3 id="org03142e6"><span class="section-number-3">4.75</span> ngx.re.sub</h3>
</div>
<div id="outline-container-orgc919263" class="outline-3">
<h3 id="orgc919263"><span class="section-number-3">4.76</span> ngx.re.gsub</h3>
</div>
<div id="outline-container-org66318d3" class="outline-3">
<h3 id="org66318d3"><span class="section-number-3">4.77</span> ngx.shared.DICT</h3>
<div class="outline-text-3" id="text-4-77">
<p>
获取由 lua_shared_dict 指令定义的名为 DICT 的共享内存区域对应的 Lua 字典对象。 共享内存区域始终由当前 nginx 服务器实例中的所有 nginx 工作进程共享。
</p>

<p>
所有这些方法都是原子操作，也就是说，对于同一个 lua_shared_dict 区域的多个 nginx 工作进程的并发访问是安全的。
</p>
</div>
</div>

<div id="outline-container-orgdb3f8fb" class="outline-3">
<h3 id="orgdb3f8fb"><span class="section-number-3">4.78</span> ngx.shared.DICT.get</h3>
<div class="outline-text-3" id="text-4-78">
<p>
检索字典 ngx.shared.DICT 中的 key。如果 key 不存在或已过期，则返回 nil
</p>
</div>
</div>

<div id="outline-container-org78f8193" class="outline-3">
<h3 id="org78f8193"><span class="section-number-3">4.79</span> ngx.shared.DICT.get_stale</h3>
<div class="outline-text-3" id="text-4-79">
<p>
与 get 方法类似，但即使 key 已经过期，也会返回该值。
</p>
</div>
</div>

<div id="outline-container-org8c4a6bb" class="outline-3">
<h3 id="org8c4a6bb"><span class="section-number-3">4.80</span> ngx.shared.DICT.set</h3>
<div class="outline-text-3" id="text-4-80">
<p>
无条件的在 ngx.shared.DICT 中设置键值对。value 参数可以是 Lua 布尔值，数字，字符串或 nil。
</p>
</div>
</div>

<div id="outline-container-orgbab06a5" class="outline-3">
<h3 id="orgbab06a5"><span class="section-number-3">4.81</span> ngx.shared.DICT.safe_set</h3>
<div class="outline-text-3" id="text-4-81">
<p>
与 set 方法类似，但在共享内存区域中的存储空间不足时，永远不会覆盖存储中（最近最少使用的）未过期的项目。在这种情况下，它将立即返回 nil 和字符串“no memory”。
</p>
</div>
</div>

<div id="outline-container-org936766b" class="outline-3">
<h3 id="org936766b"><span class="section-number-3">4.82</span> ngx.shared.DICT.add</h3>
<div class="outline-text-3" id="text-4-82">
<p>
类似 set 方法，但是只有键不存在，才将键值对存储到字典 ngx.shared.DICT 中。
</p>

<p>
如果键参数已存在于字典中（并且未确定过期），则成功返回值将为 false，并且错误返回值将为 “exists”。
</p>
</div>
</div>

<div id="outline-container-org16f63a7" class="outline-3">
<h3 id="org16f63a7"><span class="section-number-3">4.83</span> ngx.shared.DICT.safe_add</h3>
<div class="outline-text-3" id="text-4-83">
<p>
与 add 方法类似，但在共享内存区域中的存储空间不足时，永远不会覆盖存储中（最近最少使用的）未过期的项目。在这种情况下，它将立即返回 nil 和字符串“no memory”。
</p>
</div>
</div>

<div id="outline-container-org718336a" class="outline-3">
<h3 id="org718336a"><span class="section-number-3">4.84</span> ngx.shared.DICT.replace</h3>
<div class="outline-text-3" id="text-4-84">
<p>
就像 set 方法一样，但是只有 key 确实存在，才将键值对存储到字典 ngx.shared.DICT 中。
</p>
</div>
</div>

<div id="outline-container-orge02d296" class="outline-3">
<h3 id="orge02d296"><span class="section-number-3">4.85</span> ngx.shared.DICT.delete</h3>
<div class="outline-text-3" id="text-4-85">
<p>
无条件地从 ngx.shared.DICT 中删除键值对。
</p>
</div>
</div>

<div id="outline-container-org7f71f93" class="outline-3">
<h3 id="org7f71f93"><span class="section-number-3">4.86</span> ngx.shared.DICT.incr</h3>
<div class="outline-text-3" id="text-4-86">
<p>
通过步长值增加 ngx.shared.DICT 中的 key 的 value（数值）。如果操作成功完成，则返回新的结果数，否则返回 nil 和错误消息。
</p>

<p>
当 key 不存在或已在共享字典中过期时：
</p>
<ol class="org-ol">
<li>如果未指定 init 参数或取值为 nil，则此方法将返回 nil 并且错误字符串 “not found”，或者</li>
<li>如果 init 参数采用数字值，则此方法将创建一个值为 init + value 的新 key。</li>
</ol>

<p>
类似 add 方法，当共享内存区域中的存储空间不足时，它还会覆盖存储中（最近最少使用的）未过期的项目。
</p>

<p>
可选的 init_ttl 参数指定了在以 init 参数初始化后 key 的到期时间（以秒为单位）。时间分辨率为 0.001 秒。如果 init_ttl 取值 0（默认值），则该项将永不过期。该参数必须和 init 一起使用，并且如果该值已经存在则无效（例如，如果它先前是通过 set 或其他类似操作）。
</p>
</div>
</div>

<div id="outline-container-orgf90c52a" class="outline-3">
<h3 id="orgf90c52a"><span class="section-number-3">4.87</span> ngx.shared.DICT.lpush</h3>
</div>
<div id="outline-container-orgfb34b8a" class="outline-3">
<h3 id="orgfb34b8a"><span class="section-number-3">4.88</span> ngx.shared.DICT.rpush</h3>
</div>
<div id="outline-container-org36d9ab0" class="outline-3">
<h3 id="org36d9ab0"><span class="section-number-3">4.89</span> ngx.shared.DICT.lpop</h3>
</div>
<div id="outline-container-org4930e78" class="outline-3">
<h3 id="org4930e78"><span class="section-number-3">4.90</span> ngx.shared.DICT.rpop</h3>
</div>
<div id="outline-container-orgc624dc9" class="outline-3">
<h3 id="orgc624dc9"><span class="section-number-3">4.91</span> ngx.shared.DICT.llen</h3>
</div>
<div id="outline-container-orgabc1182" class="outline-3">
<h3 id="orgabc1182"><span class="section-number-3">4.92</span> ngx.shared.DICT.ttl</h3>
</div>
<div id="outline-container-org4615f19" class="outline-3">
<h3 id="org4615f19"><span class="section-number-3">4.93</span> ngx.shared.DICT.expire</h3>
<div class="outline-text-3" id="text-4-93">
<p>
更新 ngx.shared.DICT 中键值对的 exptime（以秒为单位）。 如果操作完成返回指示成功的布尔值，否则返回 nil 和错误消息。
</p>

<p>
如果该键不存在，则此方法将返回 nil 并且错误字符串 “not found”。
</p>

<p>
exptime 参数的分辨率为 0.001 秒。 如果 exptime 为 0，则该项将永不过期。
</p>
</div>
</div>

<div id="outline-container-org6981aff" class="outline-3">
<h3 id="org6981aff"><span class="section-number-3">4.94</span> ngx.shared.DICT.flush_all</h3>
<div class="outline-text-3" id="text-4-94">
<p>
刷新字典中的所有项目。此方法不会释放字典中的所有内存块，而只是将所有现有项目标记为已过期。
</p>
</div>
</div>

<div id="outline-container-org60b5c67" class="outline-3">
<h3 id="org60b5c67"><span class="section-number-3">4.95</span> ngx.shared.DICT.flush_expired</h3>
<div class="outline-text-3" id="text-4-95">
<p>
刷新字典中的过期项，直到可选的 max_count 参数指定的最大数量。 当 max_count 参数给定 0 或根本没有给出时，则表示无限制。 返回实际刷新的项目数。
</p>

<p>
与 flush_all 方法不同，此方法实际上释放了过期项目使用的内存。
</p>
</div>
</div>

<div id="outline-container-orgdbed527" class="outline-3">
<h3 id="orgdbed527"><span class="section-number-3">4.96</span> ngx.shared.DICT.get_keys</h3>
</div>
<div id="outline-container-orgc97f8c0" class="outline-3">
<h3 id="orgc97f8c0"><span class="section-number-3">4.97</span> ngx.shared.DICT.capacity</h3>
</div>
<div id="outline-container-orgd58fc9e" class="outline-3">
<h3 id="orgd58fc9e"><span class="section-number-3">4.98</span> ngx.shared.DICT.free_space</h3>
<div class="outline-text-3" id="text-4-98">
<p>
检索 ngx.shared.DICT 的可用页面大小（以字节为单位）。可用于告警。
</p>
</div>
</div>

<div id="outline-container-org3f470d5" class="outline-3">
<h3 id="org3f470d5"><span class="section-number-3">4.99</span> ngx.socket.udp</h3>
</div>
<div id="outline-container-orge0b9ec2" class="outline-3">
<h3 id="orge0b9ec2"><span class="section-number-3">4.100</span> udpsock:setpeername</h3>
</div>
<div id="outline-container-org915a07e" class="outline-3">
<h3 id="org915a07e"><span class="section-number-3">4.101</span> udpsock:send</h3>
</div>
<div id="outline-container-orgda9c700" class="outline-3">
<h3 id="orgda9c700"><span class="section-number-3">4.102</span> udpsock:receive</h3>
</div>
<div id="outline-container-org5a9ca69" class="outline-3">
<h3 id="org5a9ca69"><span class="section-number-3">4.103</span> udpsock:close</h3>
</div>
<div id="outline-container-org8a3b965" class="outline-3">
<h3 id="org8a3b965"><span class="section-number-3">4.104</span> udpsock:settimeout</h3>
</div>
<div id="outline-container-org9c134ac" class="outline-3">
<h3 id="org9c134ac"><span class="section-number-3">4.105</span> ngx.socket.stream</h3>
</div>
<div id="outline-container-org7f7a9fa" class="outline-3">
<h3 id="org7f7a9fa"><span class="section-number-3">4.106</span> ngx.socket.tcp</h3>
<div class="outline-text-3" id="text-4-106">
<p>
创建并返回一个 TCP 或面向流的 unix 域套接字对象（也称为“cosocket”对象的一种类型）。此对象支持以下方法：
</p>
</div>
</div>

<div id="outline-container-orge712211" class="outline-3">
<h3 id="orge712211"><span class="section-number-3">4.107</span> tcpsock:connect</h3>
</div>
<div id="outline-container-org2fcbbca" class="outline-3">
<h3 id="org2fcbbca"><span class="section-number-3">4.108</span> tcpsock:sslhandshake</h3>
</div>
<div id="outline-container-orgfbe3403" class="outline-3">
<h3 id="orgfbe3403"><span class="section-number-3">4.109</span> tcpsock:send</h3>
</div>
<div id="outline-container-orgd110f70" class="outline-3">
<h3 id="orgd110f70"><span class="section-number-3">4.110</span> tcpsock:receive</h3>
</div>
<div id="outline-container-orgda8e305" class="outline-3">
<h3 id="orgda8e305"><span class="section-number-3">4.111</span> tcpsock:receiveany</h3>
</div>
<div id="outline-container-orgd79abd9" class="outline-3">
<h3 id="orgd79abd9"><span class="section-number-3">4.112</span> tcpsock:receiveuntil</h3>
</div>
<div id="outline-container-orgd1fe997" class="outline-3">
<h3 id="orgd1fe997"><span class="section-number-3">4.113</span> tcpsock:close</h3>
</div>
<div id="outline-container-orgced7222" class="outline-3">
<h3 id="orgced7222"><span class="section-number-3">4.114</span> tcpsock:settimeout</h3>
</div>
<div id="outline-container-orgc206412" class="outline-3">
<h3 id="orgc206412"><span class="section-number-3">4.115</span> tcpsock:settimeouts</h3>
</div>
<div id="outline-container-org0f19a80" class="outline-3">
<h3 id="org0f19a80"><span class="section-number-3">4.116</span> tcpsock:setoption</h3>
</div>
<div id="outline-container-org2f31339" class="outline-3">
<h3 id="org2f31339"><span class="section-number-3">4.117</span> tcpsock:setkeepalive</h3>
</div>
<div id="outline-container-orgcfabf39" class="outline-3">
<h3 id="orgcfabf39"><span class="section-number-3">4.118</span> tcpsock:getreusedtimes</h3>
</div>
<div id="outline-container-orge117107" class="outline-3">
<h3 id="orge117107"><span class="section-number-3">4.119</span> ngx.socket.connect</h3>
</div>
<div id="outline-container-org8e62699" class="outline-3">
<h3 id="org8e62699"><span class="section-number-3">4.120</span> ngx.get_phase</h3>
</div>
<div id="outline-container-org90a086d" class="outline-3">
<h3 id="org90a086d"><span class="section-number-3">4.121</span> ngx.thread.spawn</h3>
</div>
<div id="outline-container-orge2d3da8" class="outline-3">
<h3 id="orge2d3da8"><span class="section-number-3">4.122</span> ngx.thread.wait</h3>
</div>
<div id="outline-container-org7b7a029" class="outline-3">
<h3 id="org7b7a029"><span class="section-number-3">4.123</span> ngx.thread.kill</h3>
</div>
<div id="outline-container-org178e703" class="outline-3">
<h3 id="org178e703"><span class="section-number-3">4.124</span> ngx.on_abort</h3>
</div>
<div id="outline-container-org3da00c6" class="outline-3">
<h3 id="org3da00c6"><span class="section-number-3">4.125</span> ngx.timer.at</h3>
<div class="outline-text-3" id="text-4-125">
<pre class="example">
syntax: hdl, err = ngx.timer.at(delay, callback, user_arg1, user_arg2, ...)
</pre>

<p>
Nginx 核心将自动调用用户回调，其参数为 premature，user_arg1，user_arg2 等，其中，premature 参数采用一个布尔值，指示它是否是一个 premature timer expiration。
</p>

<p>
premature timer expiration 发生在当 Nginx worker 进程尝试关闭时，例如在 HUP 信号触发的 Nginx 配置重新加载或 Nginx 服务器关闭时。 当 Nginx 工作者试图关闭时，人们不能再调用 ngx.timer.at 来创建具有非零延迟的新计时器，在这种情况下，ngx.timer.at 将返回 “conditional false” 值和描述错误的字符串 ，即 “process exiting”。
</p>

<p>
当计时器到期时，计时器回调中的用户 Lua 代码在完全脱离创建计时器的原始请求的 “轻线程” 中运行。 因此，与创建它们的请求具有相同生命周期的对象（如 cosockets）无法在原始请求和计时器用户回调函数之间共享。
</p>
</div>
</div>
<div id="outline-container-org0059440" class="outline-3">
<h3 id="org0059440"><span class="section-number-3">4.126</span> ngx.timer.every</h3>
</div>
<div id="outline-container-org169ad83" class="outline-3">
<h3 id="org169ad83"><span class="section-number-3">4.127</span> ngx.timer.running_count</h3>
</div>
<div id="outline-container-orgb1d110d" class="outline-3">
<h3 id="orgb1d110d"><span class="section-number-3">4.128</span> ngx.timer.pending_count</h3>
</div>
<div id="outline-container-org7a9a4a8" class="outline-3">
<h3 id="org7a9a4a8"><span class="section-number-3">4.129</span> ngx.config.subsystem</h3>
</div>
<div id="outline-container-orgd9e09b0" class="outline-3">
<h3 id="orgd9e09b0"><span class="section-number-3">4.130</span> ngx.config.debug</h3>
</div>
<div id="outline-container-org76ba007" class="outline-3">
<h3 id="org76ba007"><span class="section-number-3">4.131</span> ngx.config.prefix</h3>
</div>
<div id="outline-container-org47e1c53" class="outline-3">
<h3 id="org47e1c53"><span class="section-number-3">4.132</span> ngx.config.nginx_version</h3>
</div>
<div id="outline-container-org1be66d1" class="outline-3">
<h3 id="org1be66d1"><span class="section-number-3">4.133</span> ngx.config.nginx_configure</h3>
</div>
<div id="outline-container-org8b0c06a" class="outline-3">
<h3 id="org8b0c06a"><span class="section-number-3">4.134</span> ngx.config.ngx_lua_version</h3>
<div class="outline-text-3" id="text-4-134">
<p>
该字段采用整数值表示当前使用的 ngx_lua 模块的版本号。例如，版本号 0.9.3 导致 Lua 号 9003。
</p>
</div>
</div>
<div id="outline-container-org43e1f43" class="outline-3">
<h3 id="org43e1f43"><span class="section-number-3">4.135</span> ngx.worker.exiting</h3>
</div>
<div id="outline-container-org7d01937" class="outline-3">
<h3 id="org7d01937"><span class="section-number-3">4.136</span> ngx.worker.pid</h3>
</div>
<div id="outline-container-org4df25b2" class="outline-3">
<h3 id="org4df25b2"><span class="section-number-3">4.137</span> ngx.worker.count</h3>
</div>
<div id="outline-container-org4850919" class="outline-3">
<h3 id="org4850919"><span class="section-number-3">4.138</span> ngx.worker.id</h3>
</div>
<div id="outline-container-org6476588" class="outline-3">
<h3 id="org6476588"><span class="section-number-3">4.139</span> ngx.semaphore</h3>
</div>
<div id="outline-container-org9d05bc7" class="outline-3">
<h3 id="org9d05bc7"><span class="section-number-3">4.140</span> ngx.balancer</h3>
</div>
<div id="outline-container-orgae540c5" class="outline-3">
<h3 id="orgae540c5"><span class="section-number-3">4.141</span> ngx.ssl</h3>
</div>
<div id="outline-container-orgc835f06" class="outline-3">
<h3 id="orgc835f06"><span class="section-number-3">4.142</span> ngx.ocsp</h3>
</div>
<div id="outline-container-org79e1a78" class="outline-3">
<h3 id="org79e1a78"><span class="section-number-3">4.143</span> ndk.set_var.DIRECTIVE</h3>
</div>
<div id="outline-container-org5e5e5d6" class="outline-3">
<h3 id="org5e5e5d6"><span class="section-number-3">4.144</span> coroutine.create</h3>
</div>
<div id="outline-container-org6a40f35" class="outline-3">
<h3 id="org6a40f35"><span class="section-number-3">4.145</span> coroutine.resume</h3>
</div>
<div id="outline-container-org141cb6a" class="outline-3">
<h3 id="org141cb6a"><span class="section-number-3">4.146</span> coroutine.yield</h3>
</div>
<div id="outline-container-org4000a9b" class="outline-3">
<h3 id="org4000a9b"><span class="section-number-3">4.147</span> coroutine.wrap</h3>
</div>
<div id="outline-container-org6e4efd3" class="outline-3">
<h3 id="org6e4efd3"><span class="section-number-3">4.148</span> coroutine.running</h3>
</div>
<div id="outline-container-org46e3a29" class="outline-3">
<h3 id="org46e3a29"><span class="section-number-3">4.149</span> coroutine.status</h3>
</div>
</div>

<div id="outline-container-org7d6d19e" class="outline-2">
<h2 id="org7d6d19e"><span class="section-number-2">5</span> Known Issues</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org99a8b1e" class="outline-3">
<h3 id="org99a8b1e"><span class="section-number-3">5.1</span> Data Sharing within an Nginx Worker</h3>
<div class="outline-text-3" id="text-5-1">
<p>
要在同一个 nginx 工作进程处理的所有请求之间全局共享数据，需要将共享数据封装到 Lua 模块中，使用 Lua <code>require</code> 导入模块，然后使用 Lua 操作共享数据。 之所以可以这么做是因为所需的 Lua 模块只加载一次，并且所有协程将共享模块的 <b>相同副本（包括其代码和数据）</b> 。 但请注意，由于每个请求的一个协程的隔离设计，Lua 全局变量（注意，不是模块级变量）不会在请求之间保持不变。
</p>

<p>
请注意，此数据共享基于 per-worker 而不是基于 per-server。也就是说，当 Nginx 主机下有多个 nginx 工作进程时，数据共享不能跨越这些工作进程之间的进程边界。
</p>

<p>
通常建议以这种方式共享只读数据。只要在计算过程中没有非阻塞 I/O 操作（包括 ngx.sleep），也可以在每个 nginx 工作进程的所有并发请求之间共享可更改的数据。只要不将控制权交给 nginx 事件循环和 ngx_lua 的轻量级线程调度程序（包括隐式的转移控制权），就不会有任何竞争条件。因此，当想要在 worker 级别共享可更改数据时，请务必非常小心。可能导致 bug 的优化很容易导致以调试的竞争条件。
</p>

<p>
如果需要服务器范围的数据共享，请使用以下一种或多种方法：
</p>
<ul class="org-ul">
<li>使用此模块提供的 ngx.shared.DICT API。</li>
<li>仅使用单个 nginx 工作器和单个服务器（但是，如果在单个计算机中存在多核 CPU 或多个 CPU，则不建议使用此方法）。</li>
<li>使用数据存储机制，如 memcached，redis，MySQL 或 PostgreSQL。内嵌该模块的 OpenResty 软件包附带了一组配套的 Nginx 模块和 Lua 库，它们提供与这些数据存储机制交互的接口。</li>
</ul>
</div>
</div>

<div id="outline-container-org3046197" class="outline-3">
<h3 id="org3046197"><span class="section-number-3">5.2</span> Lua Variable Scope</h3>
<div class="outline-text-3" id="text-5-2">
<p>
待补充
</p>
</div>
</div>

<div id="outline-container-org981c9b6" class="outline-3">
<h3 id="org981c9b6"><span class="section-number-3">5.3</span> Cosockets Not Available Everywhere</h3>
<div class="outline-text-3" id="text-5-3">
<p>
待补充
</p>
</div>
</div>

<div id="outline-container-org228724b" class="outline-3">
<h3 id="org228724b"><span class="section-number-3">5.4</span> Special Escaping Sequences</h3>
<div class="outline-text-3" id="text-5-4">
<p>
待补充
</p>
</div>
</div>
</div>

<div id="outline-container-org611d38e" class="outline-2">
<h2 id="org611d38e"><span class="section-number-2">6</span> third-party</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org5b7809a" class="outline-3">
<h3 id="org5b7809a"><span class="section-number-3">6.1</span> lua-resty-string</h3>
<div class="outline-text-3" id="text-6-1">
<p>
主要提供了一系列 to_hex() 和 atoi()两个函数。
</p>
</div>
</div>

<div id="outline-container-org78429ba" class="outline-3">
<h3 id="org78429ba"><span class="section-number-3">6.2</span> lua-resty-logger-socket</h3>
<div class="outline-text-3" id="text-6-2">
<p>
这个 lua 库是 ngx_lua 的远程日志记录模块。旨在取代 Nginx 的标准 ngx_http_log_module，以通过非阻塞套接字将访问日志推送到远程服务器。该库利用了 ngx_lua 的 cosocket API，后者确保了 100％的非阻塞行为。
</p>
</div>
</div>

<div id="outline-container-org89bae80" class="outline-3">
<h3 id="org89bae80"><span class="section-number-3">6.3</span> lua-resty-mysql</h3>
</div>

<div id="outline-container-orgcdb2e9e" class="outline-3">
<h3 id="orgcdb2e9e"><span class="section-number-3">6.4</span> lua-resty-redis</h3>
</div>

<div id="outline-container-orgf1729e2" class="outline-3">
<h3 id="orgf1729e2"><span class="section-number-3">6.5</span> lua-resty-upload</h3>
</div>

<div id="outline-container-org5aee7fc" class="outline-3">
<h3 id="org5aee7fc"><span class="section-number-3">6.6</span> <a href="https://github.com/cloudflare/lua-resty-cookie">lua-resty-cookie</a></h3>
</div>

<div id="outline-container-org80eb7e3" class="outline-3">
<h3 id="org80eb7e3"><span class="section-number-3">6.7</span> <a href="https://github.com/openresty/stream-lua-nginx-module">stream-lua-nginx-module</a></h3>
</div>

<div id="outline-container-org469dd08" class="outline-3">
<h3 id="org469dd08"><span class="section-number-3">6.8</span> <a href="https://github.com/openresty/openresty-systemtap-toolkit">openresty-systemtap-toolkit</a></h3>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
该文档主要来自<a href="https://github.com/openresty/lua-nginx-module">lua-nginx-module on github</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: liushangliang</p>
<p class="email">Email: <a href="mailto:phenix3443+github@gmail.com">phenix3443+github@gmail.com</a></p>
<p class="date">Created: 2019-09-10 二 19:58</p>
<p class="validation"></p>
</div>
</body>
</html>
